<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="author" content="chuddy">
    <meta name="keywords" content="">
    <title>初识php反序列化 ~ chuddy&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>chuddy&#39;s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("/post.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">初识php反序列化</p>
            <br>
            
            <p>Tuesday, January 8th 2019, 11:39 pm</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h2 id="php的序列化与反序列化"><a href="#php的序列化与反序列化" class="headerlink" title="php的序列化与反序列化"></a>php的序列化与反序列化</h2><p>关于这个时有两个函数的 serialize()和unserialize()<br><a id="more"></a></p>
<h3 id="serialize-函数"><a href="#serialize-函数" class="headerlink" title="serialize()函数"></a>serialize()函数</h3><p>当在php创建了一个对象后，可以通过serialize()函数把这个对象转变成一个字符串，保存对象的值方便之后的传递与使用。</p>
<h3 id="序列化格式"><a href="#序列化格式" class="headerlink" title="序列化格式"></a>序列化格式</h3><h4 id="整形的序列化格式"><a href="#整形的序列化格式" class="headerlink" title="整形的序列化格式"></a>整形的序列化格式</h4><pre><code>&lt;?php
    $number = 34;

    var_dump(serialize($number));
?&gt;

输出结果为：
string(5) &quot;i:34;&quot; 
</code></pre><p>解释：</p>
<pre><code>因为serialize()函数所以输出的是一个字符串类型的
i表示integer类型
34就是变量的值
</code></pre><h3 id="doule类型的序列化格式"><a href="#doule类型的序列化格式" class="headerlink" title="doule类型的序列化格式"></a>doule类型的序列化格式</h3><pre><code>&lt;?php
    $double = 5.5;

    var_dump(serialize(double));
?&gt;

输出结果为：
string(6) &quot;d:5.5;&quot; 

</code></pre><p>解释</p>
<pre><code>d 表示double类型
5.5 为变量的值
</code></pre><h3 id="string类型的序列化格式"><a href="#string类型的序列化格式" class="headerlink" title="string类型的序列化格式"></a>string类型的序列化格式</h3><pre><code>&lt;?php
    $str = &#39;chuddy&#39;;
    var_dump(serialize($str));
    echo &quot;&lt;br&gt;&quot;;
?&gt;

输出结果为：
string(13) &quot;s:6:&quot;chuddy&quot;;&quot; 

</code></pre><p>解释：</p>
<pre><code>s 代表string类型
chuddy 为变量的值
</code></pre><h1 id="布尔类型的序列化格式"><a href="#布尔类型的序列化格式" class="headerlink" title="布尔类型的序列化格式"></a>布尔类型的序列化格式</h1><pre><code>&lt;?php
    $bool = true;
    $bool_1 = false;
    var_dump(serialize($bool));
    echo &quot;&lt;br&gt;&quot;;
    var_dump(serialize($bool_1));
    echo &quot;&lt;br&gt;&quot;;
?&gt;

输出结果：
string(4) &quot;b:1;&quot;
string(4) &quot;b:0;&quot; 
</code></pre><p>解释：</p>
<pre><code>b 表示布尔类型
1 表示布尔变量的值为true
0 表示布尔类型的值为false
</code></pre><h3 id="null类型的序列化格式"><a href="#null类型的序列化格式" class="headerlink" title="null类型的序列化格式"></a>null类型的序列化格式</h3><pre><code>&lt;?php
    $null = null;
    var_dump(serialize($null));
?&gt;

输出结果：
string(2) &quot;N;&quot; 
</code></pre><p>解释</p>
<pre><code>N  代表的null类型
</code></pre><h3 id="数组类型的序列化格式"><a href="#数组类型的序列化格式" class="headerlink" title="数组类型的序列化格式"></a>数组类型的序列化格式</h3><pre><code>&lt;?php
    $arr = array(&#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2);
    var_dump(serialize($arr));
    echo &quot;&lt;br&gt;&quot;;
?&gt;

输出结果：
string(30) &quot;a:2:{s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;i:2;}&quot; 
</code></pre><p>解释：</p>
<pre><code>a 表示array类型
2 表示数组的长度
{} 内的时数组各个值得类型，长度以及值
</code></pre><h3 id="类的序列化格式"><a href="#类的序列化格式" class="headerlink" title="类的序列化格式"></a>类的序列化格式</h3><pre><code>&lt;?php
class chuddy {
    public $data;
    private $pass;

    public function __construct($data, $pass)
    {
        $this-&gt;data = $data;
        $this-&gt;pass = $pass;
    }
}
$cc = new chuddy(&#39;chuddy&#39;, &#39;haha&#39;);
var_dump(serialize($cc));
?&gt;

输出结果为：
string(72) &quot;O:6:&quot;chuddy&quot;:2:{s:4:&quot;data&quot;;s:6:&quot;chuddy&quot;;s:12:&quot;chuddypass&quot;;s:4:&quot;haha&quot;;}&quot; 
</code></pre><p>解释：</p>
<pre><code>O 代表对象类型
2 代表类里的变量多少

</code></pre><h3 id="序列化对象"><a href="#序列化对象" class="headerlink" title="序列化对象"></a>序列化对象</h3><pre><code>class CB {
    public $CB_data = &#39;cb&#39;;
}

class CC extends CB{
    const SECOND = 60;

    public $data;
    private $pass;

    public function __construct($data, $pass)
    {
        $this-&gt;data = $data;
        $this-&gt;pass = $pass;
    }

    public function setPass($pass)
    {
        $this-&gt;pass = $pass;
    }
}
$cc = new CC(&#39;uu&#39;, true);

var_dump(serialize($cc));

输出结果为：

string(75) &quot;O:2:&quot;CC&quot;:3:{s:4:&quot;data&quot;;s:2:&quot;uu&quot;;s:8:&quot; CC pass&quot;;b:1;s:7:&quot;CB_data&quot;;s:2:&quot;cb&quot;;}&quot;

</code></pre><p>序列化对象时，不会保存常量的值。对于父类中的变量，则会保留。</p>
<h3 id="对象序列化自定义"><a href="#对象序列化自定义" class="headerlink" title="对象序列化自定义"></a>对象序列化自定义</h3><pre><code>在序列化对象时，有一些敏感数据，我们不需要保存，这里该如何处理呢

在我们调用serialize()函数时，该函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化的操作。可以通过重载这个方法，从而自定义序列化行为
</code></pre><pre><code>class User{
    const SITE = &#39;uusama&#39;;

    public $username;
    public $nickname;
    private $password;

    public function __construct($username, $nickname, $password)
    {
        $this-&gt;username = $username;
        $this-&gt;nickname = $nickname;
        $this-&gt;password = $password;
    }

    // 重载序列化调用的方法
    public function __sleep()
    {
        // 返回需要序列化的变量名，过滤掉password变量
        return array(&#39;username&#39;, &#39;nickname&#39;);
    }
}
$user = new User(&#39;uusama&#39;, &#39;uu&#39;, &#39;123456&#39;);
var_dump(serialize($user));


返回结果为：
string(67) &quot;O:4:&quot;User&quot;:2:{s:8:&quot;username&quot;;s:6:&quot;uusama&quot;;s:8:&quot;nickname&quot;;s:2:&quot;uu&quot;;}&quot;
</code></pre><p>这样就忽略了password字段的值 可以保护敏感数据</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>所以序列化对于不同类型得到的字符串格式为：</p>
<ul>
<li>String : s:size:value;</li>
<li>Integer : i:value;</li>
<li>Boolean : b:value;(保存1或0)</li>
<li>Null : N;</li>
<li>Array : a:size:{key definition;value definition;(repeated per element)}</li>
<li>Object : O:strlen(object name):object name:object size:{s:strlen(property name):property name:property definition;(repeated per property)}</li>
</ul>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><h3 id="反序列化函数"><a href="#反序列化函数" class="headerlink" title="反序列化函数"></a>反序列化函数</h3><p>unserialize()反序列化函数用于将单一的已序列化的变量转换回PHP的值<br>注意：</p>
<ul>
<li>如果传递的字符串不可解序列化，则返回false，并产生一个E_NOTICE</li>
<li>返回的是转换之后的值，可为integer、float、string、array或object</li>
<li>若被反序列化的变量时一个对象，在成功重新构造对象之后，PHP会自动的试图去调用__wakeup()成员函数（如果存在的话）</li>
</ul>
<pre><code>class User{
    const SITE = &#39;uusama&#39;;

    public $username;
    public $nickname;
    private $password;

    public function __construct($username, $nickname, $password)
    {
        $this-&gt;username = $username;
        $this-&gt;nickname = $nickname;
        $this-&gt;password = $password;
    }

    // 重载序列化调用的方法
    public function __sleep()
    {
        // 返回需要序列化的变量名，过滤掉password变量
        return array(&#39;username&#39;, &#39;nickname&#39;);
    }
    public function __wakeup()
    {
        $this-&gt;password = $this-&gt;username;
    }
}
$user_ser = &#39;O:4:&quot;User&quot;:2:{s:8:&quot;username&quot;;s:6:&quot;uusama&quot;;s:8:&quot;nickname&quot;;s:2:&quot;uu&quot;;}&#39;;
var_dump(unserialize($user_ser))


输出结果：
object(User)#3 (3) { [&quot;username&quot;]=&gt; string(6) &quot;uusama&quot; [&quot;nickname&quot;]=&gt; string(2) &quot;uu&quot; [&quot;password&quot;:&quot;User&quot;:private]=&gt; string(6) &quot;uusama&quot; } 

我也尝试了一下没有__wakeup()的情况 输出结果为：
object(User)#3 (3) { [&quot;username&quot;]=&gt; string(6) &quot;uusama&quot; [&quot;nickname&quot;]=&gt; string(2) &quot;uu&quot; [&quot;password&quot;:&quot;User&quot;:private]=&gt; NULL } 
</code></pre><ul>
<li>__wakeup()函数在对象被构建以后执行，所以$this-&gt;username的值不为空</li>
<li>反序列化时，会尽量将变量值进行匹配并复制给序列化后的对象</li>
</ul>
<h3 id="未定义的类的处理"><a href="#未定义的类的处理" class="headerlink" title="未定义的类的处理"></a>未定义的类的处理</h3><pre><code>$user_ser = &#39;O:4:&quot;haha&quot;:2:{s:8:&quot;username&quot;;s:6:&quot;uusama&quot;;s:8:&quot;nickname&quot;;s:2:&quot;uu&quot;;}&#39;;
var_dump(unserialize($user_ser));
echo &quot;&lt;br&gt;&quot;;

haha这个类是没有定义的 但是还能正常输出 没有报错 输出结果为：
object(__PHP_Incomplete_Class)#3 (3) { [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt; string(4) &quot;haha&quot; [&quot;username&quot;]=&gt; string(6) &quot;uusama&quot; [&quot;nickname&quot;]=&gt; string(2) &quot;uu&quot; } 
</code></pre><p>有两种方案进行修复</p>
<ul>
<li>定义__autoload()等函数，指定发现未定义类时加载类的定义文件</li>
<li>可通过 php.ini、ini_set() 或 .htaccess 定义unserialize_callback_func。每次实例化一个未定义类时它都会被调用</li>
</ul>
<pre><code>// unserialize_callback_func 从 PHP 4.2.0 起可用
ini_set(&#39;unserialize_callback_func&#39;, &#39;mycallback&#39;); // 设置您的回调函数
function mycallback($classname) 
{
   // 只需包含含有类定义的文件
   // $classname 指出需要的是哪一个类
}


// 建议使用下面的函数，代替__autoload()
spl_autoload_register(function ($class_name) {
    // 动态加载未定义类的定义文件
    require_once $class_name . &#39;.php&#39;;
});


</code></pre><h2 id="附上参考链接-http-uusama-com-663-html"><a href="#附上参考链接-http-uusama-com-663-html" class="headerlink" title="附上参考链接 http://uusama.com/663.html"></a>附上参考链接 <a href="http://uusama.com/663.html" target="_blank" rel="noopener">http://uusama.com/663.html</a></h2>
                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;web漏洞</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>